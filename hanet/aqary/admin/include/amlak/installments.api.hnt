<?php
/**
 * Installments API - Handle installment operations
 *
 * Actions:
 * - get_installment
 * - record_payment
 * - update_installment
 * - cancel_installment
 * - get_payment_history
 * - calculate_late_fees
 *
 * @version 2.0-debug
 * @date 2025-01-18
 */

define('API_VERSION', '2.0-debug-' . filemtime(__FILE__));

// Suppress deprecation warnings for clean JSON output
error_reporting(E_ERROR | E_PARSE);
ini_set('display_errors', '0');

// Aggressive cache clearing
if (function_exists('opcache_invalidate')) {
    opcache_invalidate(__FILE__, true);
}
if (function_exists('opcache_reset')) {
    @opcache_reset();
}

// Set response type to JSON and prevent caching
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('Pragma: no-cache');
header('Expires: 0');

// Include required files
include_once "../../../reqloginajax.hnt";
include_once "../../../connectdb.hnt";
include_once "../../../data.hnt";
require_once 'CalendarManager.class.hnt';
require_once '../../../lib/storage/helpers.php';

// Initialize
$calendar = new CalendarManager();

// Initialize user data from session
$user_data = isset($_SESSION['user_data']) ? $_SESSION['user_data'] : ['name' => 'Unknown', 'userid' => 1];

// Get action and trim whitespace
$action = isset($_REQUEST['action']) ? trim($_REQUEST['action']) : '';



// Response array
$response = ['success' => false, 'message' => '', 'data' => null];

// Check if action is provided
if (empty($action)) {
    $response['message'] = 'لم يتم تحديد العملية المطلوبة (action parameter is missing)';
    $response['data'] = [
        'error' => 'No action specified',
        'available_actions' => ['get_installment', 'record_payment', 'update_installment', 'cancel_installment', 'get_payment_history', 'calculate_late_fees', 'add_installment', 'mark_all_paid', 'bulk_payment']
    ];
    echo json_encode($response, JSON_UNESCAPED_UNICODE);
    exit;
}

try {
    switch ($action) {
        case 'debug_info':
            // Special debug endpoint
            $response['success'] = true;
            $response['message'] = 'Debug information';
            $response['data'] = [
                'api_version' => API_VERSION,
                'file_path' => __FILE__,
                'file_mtime' => date('Y-m-d H:i:s', filemtime(__FILE__)),
                'current_time' => date('Y-m-d H:i:s'),
                'received_action' => $action,
                'all_params' => array_keys($_REQUEST),
                'php_version' => PHP_VERSION,
                'opcache_enabled' => function_exists('opcache_get_status') ? opcache_get_status() : 'Not available'
            ];
            break;

        case 'get_installment':
            $response = getInstallment($_REQUEST, $link, $calendar);
            break;

        case 'record_payment':
            $response = recordPayment($_REQUEST, $link, $user_data);
            break;

        case 'update_installment':
            $response = updateInstallment($_REQUEST, $link, $calendar, $user_data);
            break;

        case 'cancel_installment':
            $response = cancelInstallment($_REQUEST, $link, $user_data);
            break;

        case 'get_payment_history':
            $response = getPaymentHistory($_REQUEST, $link);
            break;

        case 'calculate_late_fees':
            $response = calculateLateFees($_REQUEST, $link, $user_data);
            break;

        case 'add_installment':
            $response = addInstallment($_REQUEST, $link, $user_data, $calendar);
            break;

        case 'mark_all_paid':
            $response = markAllAsPaid($_REQUEST, $link, $user_data);
            break;

        case 'bulk_payment':
            $response = bulkPayment($_REQUEST, $link, $user_data);
            break;

        default:
            $validActions = ['get_installment', 'record_payment', 'update_installment', 'cancel_installment', 'get_payment_history', 'calculate_late_fees', 'add_installment', 'mark_all_paid', 'bulk_payment'];
            $response['message'] = 'عملية غير صالحة: "' . htmlspecialchars($action) . '"';
            $response['data'] = [
                'received_action' => $action,
                'action_length' => strlen($action),
                'action_bytes' => bin2hex($action),
                'valid_actions' => $validActions,
                'hint' => 'العمليات المتاحة: ' . implode(', ', $validActions),
                'all_request_keys' => array_keys($_REQUEST)
            ];
    }
} catch (Exception $e) {
    $response['success'] = false;
    $response['message'] = 'خطأ: ' . $e->getMessage();
    $response['data'] = [
        'error_type' => 'exception',
        'action_attempted' => $action,
        'file' => basename($e->getFile()),
        'line' => $e->getLine()
    ];
}

// Add API version to all responses for debugging
$response['_api_version'] = API_VERSION;
$response['_timestamp'] = time();



// Output JSON response
echo json_encode($response, JSON_UNESCAPED_UNICODE);
exit;

/**
 * Get single installment data
 */
function getInstallment($data, $link, $calendar) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    $kastid = isset($data['kastid']) ? intval($data['kastid']) : 0;

    $sql = "SELECT a.*, e.calendar_type
            FROM aksat a
            LEFT JOIN egar e ON a.egar_id = e.rakam3akdid
            WHERE a.kastid = '$kastid'";
    $result = mysql_query($sql, $link);

    if ($row = mysql_fetch_assoc($result)) {
        $calendarType = isset($row['calendar_type']) ? intval($row['calendar_type']) : 0;

        // Format date for display (Arabic text format)
        $row['kastdate_formatted'] = $calendar->formatDateForDisplay($row['kastdate'], $calendarType);

        // Format date for datepicker input (dd/mm/yyyy format)
        $row['kastdate_input'] = date('d/m/Y', $row['kastdate']);

        // Calculate total and remaining amounts
        $totalAmount = $row['kastvalue'] +
                      ($row['water'] ?? 0) +
                      ($row['sa3ee'] ?? 0) +
                      ($row['services'] ?? 0) +
                      ($row['late_fee'] ?? 0);

        $row['total_amount'] = $totalAmount;
        $row['amount_remaining'] = $totalAmount - ($row['amount_paid'] ?? 0);

        $response['success'] = true;
        $response['data'] = $row;
    } else {
        $response['message'] = 'القسط غير موجود';
    }

    return $response;
}

/**
 * Record payment for installment
 */
function recordPayment($data, $link, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $kastid = isset($data['kastid']) ? intval($data['kastid']) : 0;
        $amount = isset($data['amount']) ? floatval($data['amount']) : 0;
        $paymentDate = isset($data['payment_date']) ? $data['payment_date'] : date('d/m/Y');
        $paymentMethod = isset($data['payment_method']) ? mysql_real_escape_string($data['payment_method']) : 'cash';
        $referenceNumber = isset($data['reference_number']) ? mysql_real_escape_string($data['reference_number']) : '';
        $notes = isset($data['notes']) ? mysql_real_escape_string($data['notes']) : '';
        $createReceipt = isset($data['create_receipt']) && $data['create_receipt'];

        // Get installment
        $sql = "SELECT * FROM aksat WHERE kastid = '$kastid'";
        $result = mysql_query($sql, $link);
        $installment = mysql_fetch_assoc($result);

        if (!$installment) {
            throw new Exception('القسط غير موجود');
        }

        // Calculate total amount
        $totalAmount = $installment['kastvalue'] +
                      ($installment['water'] ?? 0) +
                      ($installment['sa3ee'] ?? 0) +
                      ($installment['services'] ?? 0) +
                      ($installment['late_fee'] ?? 0);

        // Calculate new amount paid
        $newAmountPaid = ($installment['amount_paid'] ?? 0) + $amount;
        $newAmountRemaining = $totalAmount - $newAmountPaid;

        // Validate amount
        if ($amount <= 0) {
            throw new Exception('المبلغ يجب أن يكون أكبر من صفر');
        }

        if ($newAmountPaid > $totalAmount) {
            throw new Exception('المبلغ المدفوع أكبر من المطلوب');
        }

        // Determine new status
        $newStatus = 'paid';
        if ($newAmountRemaining > 0) {
            $newStatus = 'partial';
        }

        // Parse payment date
        list($day, $month, $year) = explode('/', $paymentDate);
        if ($year < 1900) {
            // Hijri date
            $calendar = new CalendarManager();
            $paymentTimestamp = $calendar->dateToTimestamp($paymentDate, 0);
        } else {
            $paymentTimestamp = mktime(0, 0, 0, $month, $day, $year);
        }

        // Get old payment tracking fields for compatibility with sanad.hnt system
        $oldDof3at = isset($installment['dof3at']) ? floatval($installment['dof3at']) : 0;
        $oldDof3atTafsel = isset($installment['dof3at_tafsel']) ? $installment['dof3at_tafsel'] : '';

        // Calculate new dof3at (old system field)
        $newDof3at = $oldDof3at + $amount;

        // Build dof3at_tafsel (payment breakdown like in sanad.hnt)
        $newDof3atTafsel = trim($oldDof3atTafsel);
        if ($newDof3atTafsel) {
            $newDof3atTafsel .= ' + ' . $amount;
        } else {
            $newDof3atTafsel = (string)$amount;
        }

        // Update installment (update BOTH old and new payment tracking fields)
        $sql = "UPDATE aksat SET
                status = '$newStatus',
                amount_paid = '$newAmountPaid',
                amount_remaining = '$newAmountRemaining',
                paid_date = '$paymentTimestamp',
                dof3at = '$newDof3at',
                dof3at_tafsel = '$newDof3atTafsel',
                iscomplete = " . ($newStatus == 'paid' ? 1 : 0) . ",
                updated_at = " . time() . "
                WHERE kastid = '$kastid'";

        if (!mysql_query($sql, $link)) {
            throw new Exception('فشل تحديث القسط: ' . mysql_error($link));
        }

        // Record payment history
        $sql = "INSERT INTO aksat_payment_history SET
                kastid = '$kastid',
                payment_date = '$paymentTimestamp',
                amount_paid = '$amount',
                payment_method = '$paymentMethod',
                reference_number = '$referenceNumber',
                notes = '$notes',
                created_by_userid = " . ($user_data['userid'] ?? 1) . ",
                created_at = " . time();

        mysql_query($sql, $link);
        $paymentHistoryId = mysql_insert_id();

        // Create receipt if requested (following sanad_process.hnt approach)
        $sanadId = null;
        if ($createReceipt) {
            // Get contract, tenant and property info
            $sql = "SELECT e.*, m.mostagername, m.mostagerid, m.mostagervatnumber,
                           ad.idaqar, ad.idsubaqar, a.aqarname
                    FROM egar e
                    LEFT JOIN mostagereen m ON e.mostagerid = m.mostagerid
                    LEFT JOIN amlakdetails ad ON e.rakam3akdid = ad.rakam3akdid
                    LEFT JOIN amlak a ON ad.idaqar = a.idaqar
                    WHERE e.rakam3akdid = " . $installment['egar_id'];
            $contractResult = mysql_query($sql, $link);
            $contract = mysql_fetch_assoc($contractResult);

            if ($contract) {
                // Check if this is the first payment or a subsequent payment
                // Only record fees (water, sa3ee, services) on FIRST payment
                $mysa3ee = $installment['sa3ee'];
                $mywater = $installment['water'];
                $myservices = $installment['services'];

                // If there was previous payment (oldDof3at > 0), don't include fees again
                if ($oldDof3at > 0) {
                    $mysa3ee = 0;
                    $mywater = 0;
                    $myservices = 0;
                }

                // Calculate VAT
                $commesion_vat = 0;
                $rentValue = $installment['kastvalue'] - $installment['water'] - $installment['sa3ee'] - $installment['services'];
                $depositeamount_vat = 0;

                if (isset($contract["vat_type"])) {
                    if ($contract["vat_type"] == 1) {
                        $commesion_vat = number_format(($mysa3ee * 0.15), 2, '.', '');
                    }
                    if ($contract["vat_type"] == 2) {
                        $commesion_vat = number_format(($mysa3ee * 0.15), 2, '.', '');
                        $depositeamount_vat = number_format(($rentValue * 0.15), 2, '.', '');
                    }
                }
                $total_vat = $commesion_vat + $depositeamount_vat;

                // Generate unique form ID
                $formuid = str_replace('.', '', microtime() . rand(11111, 99999));

                // Payment method mapping
                $nakda = 1; // Default to cash
                if ($paymentMethod == 'bank_transfer') $nakda = 2;
                elseif ($paymentMethod == 'check') $nakda = 3;
                elseif ($paymentMethod == 'online') $nakda = 4;

                // Build payment description
                $mybyan = 'دفعة قسط إيجار - قسط رقم ' . $installment['kastname'];
                if (!empty($notes)) {
                    $mybyan .= ' - ' . $notes;
                }

                // Get period (full date format dd/mm/yyyy)
                $period = date('d/m/Y', $paymentTimestamp);

                // Insert revenue record (eradat table) - only include fees on first payment
                $sql = "INSERT INTO eradat SET
                        idaqar='" . $contract['idaqar'] . "',
                        idsubaqar='" . $contract['idsubaqar'] . "',
                        mostagername='" . mysql_real_escape_string($contract['mostagername']) . "',
                        mostagerid='" . $contract['mostagerid'] . "',
                        recivername='" . mysql_real_escape_string($user_data['name'] ?? 'Admin') . "',
                        amount='$amount',
                        paymentdate='$paymentTimestamp',
                        pymentdesription='" . mysql_real_escape_string($mybyan) . "',
                        sanadrakam='0',
                        kastid='$kastid',
                        mysa3ee='$mysa3ee',
                        mywater='$mywater',
                        services='$myservices',
                        formuid='$formuid'";

                mysql_query($sql, $link);

                // Insert receipt voucher (sanad table - following sanad_process.hnt structure)
                $sql = "INSERT INTO sanad SET
                        period='$period',
                        mostagerid='" . $contract['mostagerid'] . "',
                        mostagername='" . mysql_real_escape_string($contract['mostagername']) . "',
                        depositeamount='$amount',
                        recivername='" . mysql_real_escape_string($user_data['name'] ?? 'Admin') . "',
                        mybyan='" . mysql_real_escape_string($mybyan) . "',
                        sanadrakam='0',
                        idaqar='" . $contract['idaqar'] . "',
                        idsubaqar='" . $contract['idsubaqar'] . "',
                        sanaddate='$paymentTimestamp',
                        cheqnumber='" . mysql_real_escape_string($referenceNumber) . "',
                        cheqon='',
                        cheqdate1='',
                        attachedimages='',
                        kastid='$kastid',
                        commesion_vat='$commesion_vat',
                        depositeamount_vat='$total_vat',
                        payment_type='$nakda',
                        notes='" . addslashes($notes) . "',
                        formuid='$formuid'";

                mysql_query($sql, $link);
                $sanadId = mysql_insert_id();

                // Update sanadrakam with the auto-generated ID
                if ($sanadId > 0) {
                    mysql_query("UPDATE eradat SET sanadrakam = '$sanadId' WHERE formuid = '$formuid'", $link);
                    mysql_query("UPDATE sanad SET sanadrakam = '$sanadId' WHERE formuid = '$formuid'", $link);

                    // Generate QR code for receipt
                    $qr_path = qr_path('vouchers.receive', "$sanadId.png");
                    ensure_dir(dirname($qr_path));

                    require_once('../../../phpqrcode.php');
                    global $vat_number;
                    $vat_number = isset($vat_number) ? $vat_number : '';
                    $barcodedata = "سند قبض رقم : $sanadId \r\n العميل: " . $contract['mostagername'] . "  \r\n  المبلغ : $amount
                        \r\n الضريبة : $total_vat \r\n الرقم الضريبي : $vat_number
                        \r\n البيان : $mybyan \r\n تاريخ الدفع  :   " . date("d/m/Y", $paymentTimestamp) . " \r\n تاريخ الاصدار : " . date("d/m/Y") . "
                    ";
                    QRcode::png($barcodedata, $qr_path, 'L', 2, 2);

                    // Update payment history with sanad ID
                    mysql_query("UPDATE aksat_payment_history SET sanad_id = '$sanadId' WHERE payment_history_id = '$paymentHistoryId'", $link);
                }
            }
        }

        // Update contract status if needed
        updateContractStatusFromInstallments($installment['egar_id'], $link);

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = 'تم تسجيل الدفعة بنجاح' . ($sanadId ? ' وتم إنشاء سند القبض رقم ' . $sanadId : '');
        $response['data'] = [
            'new_amount_paid' => $newAmountPaid,
            'new_amount_remaining' => $newAmountRemaining,
            'new_status' => $newStatus,
            'payment_history_id' => $paymentHistoryId,
            'sanad_id' => $sanadId
        ];

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Update installment details
 */
function updateInstallment($data, $link, $calendar, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $kastid = isset($data['kastid']) ? intval($data['kastid']) : 0;

        // Get old values for history
        $sql = "SELECT * FROM aksat WHERE kastid = '$kastid'";
        $result = mysql_query($sql, $link);
        $oldValues = mysql_fetch_assoc($result);

        if (!$oldValues) {
            throw new Exception('القسط غير موجود');
        }

        // Parse date if provided
        $kastdate = $oldValues['kastdate'];
        if (isset($data['kastdate']) && !empty($data['kastdate'])) {
            // Get calendar type from contract
            $sql = "SELECT calendar_type FROM egar WHERE rakam3akdid = " . $oldValues['egar_id'];
            $result = mysql_query($sql, $link);
            $contract = mysql_fetch_assoc($result);
            $calendarType = $contract['calendar_type'] ?? 0;

            $kastdate = $calendar->dateToTimestamp($data['kastdate'], $calendarType);
        }

        // Get new values
        $kastname = isset($data['kastname']) ? mysql_real_escape_string($data['kastname']) : $oldValues['kastname'];
        $kastvalue = isset($data['kastvalue']) ? floatval($data['kastvalue']) : $oldValues['kastvalue'];
        $water = isset($data['water']) ? floatval($data['water']) : $oldValues['water'];
        $sa3ee = isset($data['sa3ee']) ? floatval($data['sa3ee']) : $oldValues['sa3ee'];
        $services = isset($data['services']) ? floatval($data['services']) : $oldValues['services'];
        $status = isset($data['status']) ? mysql_real_escape_string($data['status']) : $oldValues['status'];
        $lateFee = isset($data['late_fee']) ? floatval($data['late_fee']) : $oldValues['late_fee'];

        // Recalculate amounts if values changed
        $totalAmount = $kastvalue + $water + $sa3ee + $services + $lateFee;
        $amountRemaining = $totalAmount - ($oldValues['amount_paid'] ?? 0);

        // Update installment
        $sql = "UPDATE aksat SET
                kastname = '$kastname',
                kastvalue = '$kastvalue',
                kastdate = '$kastdate',
                water = '$water',
                sa3ee = '$sa3ee',
                services = '$services',
                status = '$status',
                late_fee = '$lateFee',
                amount_remaining = '$amountRemaining',
                updated_at = " . time() . "
                WHERE kastid = '$kastid'";

        if (!mysql_query($sql, $link)) {
            throw new Exception('فشل تحديث القسط: ' . mysql_error($link));
        }

        // Log to history - using local function defined in this file
        // Note: contract_lifecycle.api.hnt cannot be required as it's a standalone API endpoint
        // that calls exit() at the end, which would terminate this script
        logInstallmentChange($kastid, 'updated', $oldValues, $data, $user_data, $link);

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = 'تم تحديث القسط بنجاح';

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Cancel installment (soft delete)
 */
function cancelInstallment($data, $link, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $kastid = isset($data['kastid']) ? intval($data['kastid']) : 0;

        // Check if already paid
        $sql = "SELECT status, amount_paid FROM aksat WHERE kastid = '$kastid'";
        $result = mysql_query($sql, $link);
        $installment = mysql_fetch_assoc($result);

        if (!$installment) {
            throw new Exception('القسط غير موجود');
        }

        if ($installment['amount_paid'] > 0) {
            throw new Exception('لا يمكن إلغاء قسط تم دفعه جزئياً أو كلياً');
        }

        // Update status to cancelled
        $sql = "UPDATE aksat SET
                status = 'cancelled',
                updated_at = " . time() . "
                WHERE kastid = '$kastid'";

        if (!mysql_query($sql, $link)) {
            throw new Exception('فشل إلغاء القسط: ' . mysql_error($link));
        }

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = 'تم إلغاء القسط بنجاح';

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Get payment history for installment
 */
function getPaymentHistory($data, $link) {
    $response = ['success' => false, 'message' => '', 'data' => []];

    $kastid = isset($data['kastid']) ? intval($data['kastid']) : 0;

    $sql = "SELECT aph.*, u.username
            FROM aksat_payment_history aph
            LEFT JOIN users u ON aph.created_by_userid = u.userid
            WHERE aph.kastid = '$kastid'
            ORDER BY aph.payment_date DESC";

    $result = mysql_query($sql, $link);
    $payments = [];

    while ($row = mysql_fetch_assoc($result)) {
        $row['payment_date'] = date('Y-m-d', $row['payment_date']);

        // Translate payment method
        $paymentMethods = [
            'cash' => 'نقدي',
            'bank_transfer' => 'تحويل بنكي',
            'check' => 'شيك',
            'online' => 'دفع إلكتروني'
        ];
        $row['payment_method_ar'] = $paymentMethods[$row['payment_method']] ?? $row['payment_method'];

        $payments[] = $row;
    }

    $response['success'] = true;
    $response['data'] = $payments;

    return $response;
}

/**
 * Calculate late fees for overdue installments
 */
function calculateLateFees($data, $link, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $egarId = isset($data['egar_id']) ? intval($data['egar_id']) : 0;
        $lateFeePercentage = isset($data['late_fee_percentage']) ? floatval($data['late_fee_percentage']) : 0.01; // 1% default
        $lateFeePerDay = isset($data['late_fee_per_day']) ? floatval($data['late_fee_per_day']) : 0;
        $maxLateFee = isset($data['max_late_fee']) ? floatval($data['max_late_fee']) : 0;

        $now = time();
        $totalFees = 0;
        $updatedCount = 0;

        // Get overdue installments
        $sql = "SELECT * FROM aksat
                WHERE egar_id = '$egarId'
                AND status = 'overdue'
                AND kastdate < $now
                AND idsubaqar > 0";

        $result = mysql_query($sql, $link);

        while ($installment = mysql_fetch_assoc($result)) {
            // Calculate days overdue
            $daysOverdue = ceil(($now - $installment['kastdate']) / (60 * 60 * 24));

            // Calculate late fee
            $baseAmount = $installment['amount_remaining'] > 0 ? $installment['amount_remaining'] :
                         ($installment['kastvalue'] + ($installment['water'] ?? 0) +
                          ($installment['sa3ee'] ?? 0) + ($installment['services'] ?? 0));

            $lateFee = 0;
            if ($lateFeePerDay > 0) {
                $lateFee = $lateFeePerDay * $daysOverdue;
            } else {
                $lateFee = $baseAmount * $lateFeePercentage * $daysOverdue;
            }

            // Apply max late fee if set
            if ($maxLateFee > 0 && $lateFee > $maxLateFee) {
                $lateFee = $maxLateFee;
            }

            // Update installment with late fee
            $sql2 = "UPDATE aksat SET
                    late_fee = '$lateFee',
                    amount_remaining = amount_remaining + ($lateFee - IFNULL(late_fee, 0)),
                    updated_at = " . time() . "
                    WHERE kastid = " . $installment['kastid'];

            mysql_query($sql2, $link);

            $totalFees += $lateFee;
            $updatedCount++;
        }

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = "تم حساب غرامات التأخير لـ $updatedCount قسط";
        $response['data'] = [
            'updated_count' => $updatedCount,
            'total_fees' => $totalFees
        ];

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Update contract status based on installment statuses
 */
function updateContractStatusFromInstallments($egarId, $link) {
    // Check for overdue installments
    $sql = "SELECT COUNT(*) as count FROM aksat
            WHERE egar_id = '$egarId'
            AND status = 'overdue'
            AND idsubaqar > 0";
    $result = mysql_query($sql, $link);
    $row = mysql_fetch_assoc($result);

    if ($row['count'] > 0) {
        // Has overdue installments - set contract to active_arrears
        $sql = "UPDATE egar SET
                status = 'active_arrears',
                updated_at = " . time() . "
                WHERE rakam3akdid = '$egarId'
                AND status = 'active'";
        mysql_query($sql, $link);
    } else {
        // No overdue installments - set back to active if was in arrears
        $sql = "UPDATE egar SET
                status = 'active',
                updated_at = " . time() . "
                WHERE rakam3akdid = '$egarId'
                AND status = 'active_arrears'";
        mysql_query($sql, $link);
    }
}

/**
 * Log installment change to history
 */
function logInstallmentChange($kastid, $action, $oldValues, $newValues, $user_data, $link) {
    $changedFields = [];
    foreach ($newValues as $key => $value) {
        if (isset($oldValues[$key]) && $oldValues[$key] != $value) {
            $changedFields[] = $key;
        }
    }

    $sql = "INSERT INTO egar_history SET
            rakam3akdid = " . $oldValues['egar_id'] . ",
            action = 'installment_$action',
            old_values = '" . mysql_real_escape_string(json_encode($oldValues)) . "',
            new_values = '" . mysql_real_escape_string(json_encode($newValues)) . "',
            changed_fields = '" . implode(',', $changedFields) . "',
            changed_by_userid = " . ($user_data['userid'] ?? 1) . ",
            changed_at = " . time() . ",
            ip_address = '" . mysql_real_escape_string($_SERVER['REMOTE_ADDR']) . "',
            notes = 'تعديل القسط رقم " . $oldValues['kastname'] . "'";

    mysql_query($sql, $link);
}

/**
 * Add new installment
 */
function addInstallment($data, $link, $user_data, $calendar) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $egarId = isset($data['egar_id']) ? intval($data['egar_id']) : 0;
        $idsubaqar = isset($data['idsubaqar']) ? intval($data['idsubaqar']) : 0;
        $kastname = isset($data['kastname']) ? mysql_real_escape_string($data['kastname']) : '';
        $kastvalue = isset($data['kastvalue']) ? floatval($data['kastvalue']) : 0;
        $water = isset($data['water']) ? floatval($data['water']) : 0;
        $sa3ee = isset($data['sa3ee']) ? floatval($data['sa3ee']) : 0;
        $services = isset($data['services']) ? floatval($data['services']) : 0;
        $kastdate = isset($data['kastdate']) ? $data['kastdate'] : date('d/m/Y');

        if (!$egarId) {
            throw new Exception('معرف العقد مطلوب (egar_id)');
        }
        if (!$kastname || trim($kastname) == '') {
            throw new Exception('اسم القسط مطلوب (kastname)');
        }
        if ($kastvalue <= 0) {
            throw new Exception('قيمة القسط يجب أن تكون أكبر من صفر (kastvalue)');
        }

        // Get contract to determine calendar type
        $sql = "SELECT calendar_type FROM egar WHERE rakam3akdid = '$egarId'";
        $result = mysql_query($sql, $link);
        $contract = mysql_fetch_assoc($result);

        if (!$contract) {
            throw new Exception('العقد غير موجود');
        }

        $calendarType = $contract['calendar_type'] ?? 0;

        // Convert date to timestamp
        $kastTimestamp = $calendar->dateToTimestamp($kastdate, $calendarType);

        // Calculate total amount
        $totalAmount = $kastvalue + $water + $sa3ee + $services;

        // Insert new installment
        $sql = "INSERT INTO aksat SET
                egar_id = '$egarId',
                idsubaqar = '$idsubaqar',
                kastname = '$kastname',
                kastvalue = '$kastvalue',
                water = '$water',
                sa3ee = '$sa3ee',
                services = '$services',
                kastdate = '$kastTimestamp',
                status = 'pending',
                iscomplete = 0,
                amount_paid = 0,
                amount_remaining = '$totalAmount',
                late_fee = 0,
                created_at = " . time() . ",
                updated_at = " . time();

        if (!mysql_query($sql, $link)) {
            throw new Exception('فشل إضافة القسط: ' . mysql_error($link));
        }

        $kastid = mysql_insert_id();

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = 'تم إضافة القسط بنجاح';
        $response['data'] = ['kastid' => $kastid];

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Mark all unpaid installments as paid
 */
function markAllAsPaid($data, $link, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $egarId = isset($data['egar_id']) ? intval($data['egar_id']) : 0;

        if (!$egarId) {
            throw new Exception('معرف العقد مطلوب');
        }

        $now = time();

        // Get count of unpaid installments
        $sql = "SELECT COUNT(*) as count FROM aksat
                WHERE egar_id = '$egarId'
                AND iscomplete = 0
                AND status NOT IN ('cancelled', 'paid')";
        $result = mysql_query($sql, $link);
        $row = mysql_fetch_assoc($result);
        $count = $row['count'];

        if ($count == 0) {
            throw new Exception('لا توجد أقساط غير مدفوعة');
        }

        // Update all unpaid installments
        $sql = "UPDATE aksat SET
                status = 'paid',
                iscomplete = 1,
                paid_date = '$now',
                amount_paid = kastvalue + IFNULL(water, 0) + IFNULL(sa3ee, 0) + IFNULL(services, 0) + IFNULL(late_fee, 0),
                amount_remaining = 0,
                updated_at = '$now'
                WHERE egar_id = '$egarId'
                AND iscomplete = 0
                AND status NOT IN ('cancelled', 'paid')";

        if (!mysql_query($sql, $link)) {
            throw new Exception('فشل تحديث الأقساط: ' . mysql_error($link));
        }

        // Update contract status
        updateContractStatusFromInstallments($egarId, $link);

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = "تم تحديد $count قسط كمدفوع";
        $response['data'] = ['updated_count' => $count];

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}

/**
 * Record bulk payment across multiple installments
 */
function bulkPayment($data, $link, $user_data) {
    $response = ['success' => false, 'message' => '', 'data' => null];

    mysql_query("START TRANSACTION", $link);

    try {
        $egarId = isset($data['egar_id']) ? intval($data['egar_id']) : 0;
        $amount = isset($data['amount']) ? floatval($data['amount']) : 0;
        $paymentMethod = isset($data['payment_method']) ? mysql_real_escape_string($data['payment_method']) : 'cash';
        $referenceNumber = isset($data['reference_number']) ? mysql_real_escape_string($data['reference_number']) : '';

        if (!$egarId) {
            throw new Exception('معرف العقد مطلوب (egar_id)');
        }
        if ($amount <= 0) {
            throw new Exception('المبلغ يجب أن يكون أكبر من صفر (amount)');
        }

        $now = time();
        $remainingAmount = $amount;
        $paidCount = 0;
        $partialCount = 0;

        // Get unpaid installments in chronological order
        $sql = "SELECT * FROM aksat
                WHERE egar_id = '$egarId'
                AND iscomplete = 0
                AND status NOT IN ('cancelled', 'paid')
                ORDER BY kastdate ASC";

        $result = mysql_query($sql, $link);

        while ($installment = mysql_fetch_assoc($result) && $remainingAmount > 0) {
            // Calculate total amount for this installment
            $totalAmount = $installment['kastvalue'] +
                          ($installment['water'] ?? 0) +
                          ($installment['sa3ee'] ?? 0) +
                          ($installment['services'] ?? 0) +
                          ($installment['late_fee'] ?? 0);

            $currentPaid = $installment['amount_paid'] ?? 0;
            $amountNeeded = $totalAmount - $currentPaid;

            if ($remainingAmount >= $amountNeeded) {
                // Full payment
                $paymentForThis = $amountNeeded;
                $newPaid = $totalAmount;
                $newRemaining = 0;
                $newStatus = 'paid';
                $isComplete = 1;
                $paidCount++;
            } else {
                // Partial payment
                $paymentForThis = $remainingAmount;
                $newPaid = $currentPaid + $remainingAmount;
                $newRemaining = $totalAmount - $newPaid;
                $newStatus = 'partial';
                $isComplete = 0;
                $partialCount++;
            }

            // Update installment
            $updateSql = "UPDATE aksat SET
                            status = '$newStatus',
                            iscomplete = '$isComplete',
                            amount_paid = '$newPaid',
                            amount_remaining = '$newRemaining',
                            paid_date = " . ($isComplete ? "'$now'" : "paid_date") . ",
                            updated_at = '$now'
                            WHERE kastid = '{$installment['kastid']}'";

            if (!mysql_query($updateSql, $link)) {
                throw new Exception('فشل تحديث القسط: ' . mysql_error($link));
            }

            // Record payment history
            $historySql = "INSERT INTO aksat_payment_history SET
                            kastid = '{$installment['kastid']}',
                            payment_date = '$now',
                            amount_paid = '$paymentForThis',
                            payment_method = '$paymentMethod',
                            reference_number = '$referenceNumber',
                            notes = 'دفعة جماعية',
                            created_by_userid = " . ($user_data['userid'] ?? 1) . ",
                            created_at = '$now'";

            mysql_query($historySql, $link);

            $remainingAmount -= $paymentForThis;
        }

        // Update contract status
        updateContractStatusFromInstallments($egarId, $link);

        // Commit transaction
        mysql_query("COMMIT", $link);

        $response['success'] = true;
        $response['message'] = 'تم تسجيل الدفعة الجماعية بنجاح';
        $response['data'] = [
            'paid_count' => $paidCount,
            'partial_count' => $partialCount,
            'remaining_amount' => $remainingAmount
        ];

    } catch (Exception $e) {
        mysql_query("ROLLBACK", $link);
        $response['message'] = $e->getMessage();
    }

    return $response;
}
?>
