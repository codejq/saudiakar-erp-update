<?php
$pageTitle = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨';
$sc_title = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨';
$sc_id = "81";
include_once "../../nocash.hnt";

$canscroll = 0;
if (isset($edit3kod) && $edit3kod) {
    $canscroll = 0;
}
$showdhmltazkeer = 0;
include_once "../../header.hnt";

require_once('../include/whatsapp_init.hnt');

$message = '';
$messageType = '';
$qrCode = '';
$pairingCode = '';

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $action = isset($_POST['action']) ? $_POST['action'] : '';

    switch ($action) {
        case 'get_qr':
            $result = $whatsappAPI->getQRCode();
            if ($result['success']) {
                $qrCode = $result['qr_code'];
                if (isset($result['qr_link'])) {
                    $qr_link = file_get_contents($result['qr_link']);
                }
                $message = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR Ø¨Ù†Ø¬Ø§Ø­. Ù‚Ù… Ø¨Ù…Ø³Ø­Ù‡ Ù…Ù† Ù‡Ø§ØªÙÙƒ';
                $messageType = 'info';
                wa_log_activity('login', 'ØªÙ… Ø·Ù„Ø¨ Ø±Ù…Ø² QR Ù„Ù„ØªØ³Ø¬ÙŠÙ„');
            } else {
                $message = 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² QR: ' . $result['error'];
                $messageType = 'danger';
            }
            break;

        case 'get_pairing_code':
            $phone = isset($_POST['phone']) ? trim($_POST['phone']) : '';
            if (empty($phone)) {
                $message = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ';
                $messageType = 'danger';
            } else {
                // Rate limiting: Check if user requested within last 60 seconds
                $lastRequestTime = isset($_SESSION['last_pairing_code_request']) ? $_SESSION['last_pairing_code_request'] : 0;
                $currentTime = time();
                $timeDiff = $currentTime - $lastRequestTime;

                if ($timeDiff < 60 && $lastRequestTime > 0) {
                    // Too soon, ask to wait
                    $remainingSeconds = 60 - $timeDiff;
                    $message = sprintf('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± %d Ø«Ø§Ù†ÙŠØ© Ù‚Ø¨Ù„ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯. Ù‡Ø°Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø± Ù…Ù† ÙˆØ§ØªØ³Ø§Ø¨.', $remainingSeconds);
                    $messageType = 'warning';
                } else {
                    // Allowed to make request
                    $result = $whatsappAPI->loginWithCode($phone);
                    if ($result['success']) {
                        $pairingCode = $result['pairing_code'];
                        $message = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†. Ø£Ø¯Ø®Ù„Ù‡ ÙÙŠ Ù‡Ø§ØªÙÙƒ';
                        $messageType = 'success';
                        // Update last request time
                        $_SESSION['last_pairing_code_request'] = $currentTime;
                        wa_log_activity('login', 'ØªÙ… Ø·Ù„Ø¨ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù† Ù„Ù„Ù‡Ø§ØªÙ: ' . $phone);
                    } else {
                        $message = 'ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†: ' . $result['error'];
                        $messageType = 'danger';

                        // Show debug information if available
                        if (isset($result['debug_response'])) {
                            $message .= '<br><br><strong>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ‚Ù†ÙŠØ© Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:</strong><br>';
                            $message .= '<pre style="background:#f8f9fa; padding:10px; border-radius:5px; font-size:12px; max-height:200px; overflow:auto;">';
                            $message .= htmlspecialchars(json_encode($result['debug_response'], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
                            $message .= '</pre>';
                        }

                        // Log the API response for debugging
                        $apiResponse = $whatsappAPI->getLastResponse();
                        if ($apiResponse) {
                            wa_log_activity('login_error', 'API Response: ' . json_encode($apiResponse));
                        }
                    }
                }
            }
            break;

        case 'logout':
            $result = $whatsappAPI->logout();
            if ($result['success']) {
                wa_update_setting('account_connected', '0');
                wa_update_setting('account_phone', '');
                wa_update_setting('account_name', '');
                $message = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­';
                $messageType = 'success';
                wa_log_activity('logout', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨');
            } else {
                $message = 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ' . $result['error'];
                $messageType = 'danger';
            }
            break;

        case 'check_connection':
            $result = $whatsappAPI->getUserInfo();
            if ($result['success'] && isset($result['data'])) {
                $userInfo = $result['data'];
                wa_update_setting('account_connected', '1');
                $accountPhone = isset($userInfo['phone']) ? str_replace('@s.whatsapp.net', '', $userInfo['phone']) : '';
                wa_update_setting('account_phone', $accountPhone);
                wa_update_setting('account_name', isset($userInfo['name']) ? $userInfo['name'] : '');
                $message = 'Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­';
                $messageType = 'success';
                wa_log_activity('login', 'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨');
            } else {
                wa_update_setting('account_connected', '0');
                $message = 'Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ØªØµÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù…Ø² QR Ø£Ùˆ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†';
                $messageType = 'warning';
            }
            break;
    }
}

// Get current account info
$accountConnected = wa_is_account_connected();
$accountPhone = wa_get_setting('account_phone', '');
$accountName = wa_get_setting('account_name', '');

// Try to get fresh user info if connected
if ($accountConnected) {
    $result = $whatsappAPI->getUserInfo();
    if ($result['success'] && isset($result['data'])) {
        $userInfo = $result['data'];
        $accountPhone = isset($userInfo['phone']) ? str_replace('@s.whatsapp.net', '', $userInfo['phone']) : $accountPhone;
        $accountName = isset($userInfo['name']) ? $userInfo['name'] : $accountName;
    } else {
        // If can't get user info, account is not really connected
        $accountConnected = false;
        wa_update_setting('account_connected', '0');
    }
}

$pageTitle = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨';
?>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fab fa-whatsapp text-success"></i> <?php echo $pageTitle; ?></h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.hnt">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a></li>
                    <li class="breadcrumb-item active"><?php echo $pageTitle; ?></li>
                </ol>
            </nav>
        </div>
    </div>

    <?php if ($message): ?>
        <div class="alert alert-<?php echo $messageType; ?> alert-dismissible fade show" role="alert">
            <?php echo $message; ?>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    <?php endif; ?>

    <!-- Real-time Connection Indicator -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div id="connection-indicator" class="connection-indicator disconnected">
                <i class="fa fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„...
            </div>
        </div>
    </div>

    <!-- Device Status (Real-time) -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div id="device-status"></div>
        </div>
    </div>

    <!-- Account Status -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header <?php echo $accountConnected ? 'bg-success' : 'bg-warning'; ?> text-white">
                    <i class="fas fa-user-check"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
                    <span id="realtime-badge" class="badge bg-light text-dark float-end">
                        <i class="fa fa-sync-alt fa-spin"></i> Ù…Ø¨Ø§Ø´Ø±
                    </span>
                </div>
                <div class="card-body">
                    <?php if ($accountConnected): ?>
                        <div class="row">
                            <div class="col-md-8">
                                <h5 id="connection-status"><i class="fas fa-check-circle text-success"></i> Ù…ØªØµÙ„</h5>
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong></td>
                                        <td><?php echo wa_format_phone_display($accountPhone); ?></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ø§Ù„Ø§Ø³Ù…:</strong></td>
                                        <td><?php echo htmlspecialchars($accountName); ?></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-4 text-end">
                                <form method="post" style="display: inline;">
                                    <input type="hidden" name="action" value="check_connection">
                                    <button type="submit" class="btn btn-info mb-2">
                                        <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§ØªØµØ§Ù„
                                    </button>
                                </form>
                                <br>
                                <form method="post" style="display: inline;">
                                    <input type="hidden" name="action" value="logout">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')">
                                        <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                                    </button>
                                </form>
                            </div>
                        </div>
                    <?php else: ?>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>ØºÙŠØ± Ù…ØªØµÙ„</strong> - ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© WhatsApp
                        </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>

    <?php if (!$accountConnected): ?>
        <!-- Login Options -->
        <div class="row">
            <!-- QR Code Login -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-qrcode"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø±Ù…Ø² QR
                    </div>
                    <div class="card-body">
                        <p>Ø§Ø³ØªØ®Ø¯Ù… Ø±Ù…Ø² QR Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø³Ø±Ø¹Ø© ÙˆØ³Ù‡ÙˆÙ„Ø© Ù…Ù† Ù‡Ø§ØªÙÙƒ</p>

                        <form method="post">
                            <input type="hidden" name="action" value="get_qr">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-qrcode"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR
                            </button>
                        </form>

                        <?php if (isset($qr_link) && $qr_link): ?>
                            <div class="qr-code-container mt-3">
                                <img src="data:image/png;base64,<?php echo base64_encode($qr_link); ?>" alt="QR Code" style="max-width: 300px; border: 3px solid #25d366; border-radius: 10px;">
                                <p class="mt-3 text-muted">
                                    <small>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ > Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª > Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© > Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²</small>
                                </p>
                            </div>
                        <?php endif; ?>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù…Ø² QR"</li>
                                <li>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ</li>
                                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª > Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</li>
                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</li>
                                <li>Ø§Ù…Ø³Ø­ Ø±Ù…Ø² QR Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pairing Code Login -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-mobile-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†
                    </div>
                    <div class="card-body">
                        <p>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†</p>

                        <form method="post">
                            <input type="hidden" name="action" value="get_pairing_code">
                            <div class="mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="text" name="phone" class="form-control form-control-lg"
                                    placeholder="05xxxxxxxx" required>
                                <small class="text-muted">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ø¯ÙˆÙ† Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©</small>
                            </div>
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-key"></i> Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†
                            </button>
                        </form>

                        <?php if ($pairingCode): ?>
                            <div class="pairing-code" style="font-size: 2rem; font-weight: bold; color: #25d366; letter-spacing: 5px; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 20px 0;">
                                <?php echo $pairingCode; ?>
                            </div>
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Ø£Ø¯Ø®Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ÙÙŠ Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø¢Ù†
                            </div>
                        <?php endif; ?>

                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle"></i>
                            <strong>Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong>
                            <ol class="mb-0 mt-2">
                                <li>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ</li>
                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†"</li>
                                <li>Ø§ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ</li>
                                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª > Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</li>
                                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø±Ø¨Ø· Ø¬Ù‡Ø§Ø²"</li>
                                <li>Ø§Ø®ØªØ± "Ø±Ø¨Ø· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"</li>
                                <li>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Important Notes -->
        <div class="row">
            <div class="col-md-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-exclamation-triangle"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©
                    </div>
                    <div class="card-body">
                        <ul>
                            <li>ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ø§ØªÙÙƒ Ù…ØªØµÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø±Ø¨Ø·Ù‡</li>
                            <li>Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø±Ù…Ø² QR Ø£Ùˆ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù† Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ Ø­ÙŠØ« ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ</li>
                            <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø«Ø¨Øª ÙˆÙ…Ø­Ø¯Ø« Ø¹Ù„Ù‰ Ù‡Ø§ØªÙÙƒ Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±Ø¨Ø·</li>
                            <li>Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø±Ù…Ø² QR Ø£Ùˆ Ø±Ù…Ø² Ø§Ù„Ø¥Ù‚Ø±Ø§Ù†ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    <?php endif; ?>
</div>

<style>
.connection-indicator {
    padding: 10px 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    transition: all 0.3s;
}

.connection-indicator.connected {
    background: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
}

.connection-indicator.disconnected {
    background: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
}

.device-list {
    list-style: none;
    padding: 0;
}

.device-item {
    padding: 12px;
    margin: 8px 0;
    background: #f8f9fa;
    border-radius: 8px;
    border-right: 4px solid #25d366;
    display: flex;
    align-items: center;
    gap: 10px;
}

.device-status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}

.device-status-indicator.online {
    background: #25d366;
    box-shadow: 0 0 8px #25d366;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.device-phone {
    color: #6c757d;
    font-size: 0.9em;
    margin-right: auto;
}
</style>

<script src="js/whatsapp_realtime.js"></script>
<script>
// Initialize real-time connection
document.addEventListener('DOMContentLoaded', function() {
    const whatsappRT = new WhatsAppRealtime({
        proxyUrl: 'ws_proxy.php',

        onDeviceUpdate: function(devices) {
            console.log('ğŸ“± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©:', devices);
            updateDeviceStatusUI(devices);

            // Update connection status
            const statusElement = document.getElementById('connection-status');
            if (statusElement) {
                if (devices.length > 0) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Ù…ØªØµÙ„';
                } else {
                    statusElement.innerHTML = '<i class="fas fa-times-circle text-danger"></i> ØºÙŠØ± Ù…ØªØµÙ„';
                }
            }
        },

        onConnectionChange: function(isConnected) {
            console.log('ğŸ”Œ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', isConnected ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„');
            updateConnectionIndicator(isConnected);

            // Update real-time badge
            const badge = document.getElementById('realtime-badge');
            if (badge) {
                if (isConnected) {
                    badge.className = 'badge bg-success text-white float-end';
                    badge.innerHTML = '<i class="fa fa-bolt"></i> Ù…Ø¨Ø§Ø´Ø±';
                } else {
                    badge.className = 'badge bg-danger text-white float-end';
                    badge.innerHTML = '<i class="fa fa-exclamation-triangle"></i> ØºÙŠØ± Ù…ØªØµÙ„';
                }
            }
        },

        onError: function(error) {
            console.error('âŒ Ø®Ø·Ø£:', error);
        }
    });

    // Start real-time updates
    whatsappRT.start();

    // Also fetch once immediately
    whatsappRT.fetchDevices(function(devices) {
        console.log('Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©:', devices);
        updateDeviceStatusUI(devices);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        whatsappRT.stop();
    });
});

<?php if ($qrCode || $pairingCode): ?>
// Auto check connection after login attempt
setTimeout(function() {
    console.log('ğŸ”„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    location.reload();
}, 180000);
<?php endif; ?>
</script>

<?php include_once "../../footer.hnt"; ?>
