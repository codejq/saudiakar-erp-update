<?php
/**
 * TODO Module Helper Functions
 * ====================================
 * Note: Charset is set in main header.hnt file
 */

// Priority labels (Arabic)
$TODO_PRIORITIES = array(
    'low' => 'Ù…Ù†Ø®ÙØ¶Ø©',
    'medium' => 'Ù…ØªÙˆØ³Ø·Ø©',
    'high' => 'Ø¹Ø§Ù„ÙŠØ©',
);

// Priority colors
$TODO_PRIORITY_COLORS = array(
    'low' => '#28a745',      // Green
    'medium' => '#ffc107',    // Yellow/Orange
    'high' => '#dc3545',      // Red
);

// Priority icons
$TODO_PRIORITY_ICONS = array(
    'low' => 'fas fa-arrow-down',
    'medium' => 'fas fa-minus',
    'high' => 'fas fa-arrow-up',
);

// Status labels
$TODO_STATUS_LABELS = array(
    0 => 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
    1 => 'Ù…ÙƒØªÙ…Ù„Ø©',
);

/**
 * Get priority label
 */
function todo_get_priority_label($priority) {
    global $TODO_PRIORITIES;
    return isset($TODO_PRIORITIES[$priority]) ? $TODO_PRIORITIES[$priority] : $priority;
}

/**
 * Get priority color
 */
function todo_get_priority_color($priority) {
    global $TODO_PRIORITY_COLORS;
    return isset($TODO_PRIORITY_COLORS[$priority]) ? $TODO_PRIORITY_COLORS[$priority] : '#6c757d';
}

/**
 * Get priority icon
 */
function todo_get_priority_icon($priority) {
    global $TODO_PRIORITY_ICONS;
    return isset($TODO_PRIORITY_ICONS[$priority]) ? $TODO_PRIORITY_ICONS[$priority] : 'fas fa-circle';
}

/**
 * Get status label
 */
function todo_get_status_label($isCompleted) {
    global $TODO_STATUS_LABELS;
    $key = $isCompleted ? 1 : 0;
    return isset($TODO_STATUS_LABELS[$key]) ? $TODO_STATUS_LABELS[$key] : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
}

/**
 * Format date for display
 */
function todo_format_date($date) {
    if (empty($date) || $date == '0000-00-00') {
        return 'â€”';
    }

    try {
        $timestamp = strtotime($date);
        return date('d/m/Y', $timestamp);
    } catch (Exception $e) {
        return $date;
    }
}

/**
 * Format datetime for display
 */
function todo_format_datetime($datetime) {
    if (empty($datetime)) {
        return 'â€”';
    }

    try {
        return date('d/m/Y H:i', strtotime($datetime));
    } catch (Exception $e) {
        return $datetime;
    }
}

/**
 * Get relative time (e.g., "Ù…Ù†Ø° Ø³Ø§Ø¹ØªÙŠÙ†")
 */
function todo_relative_time($datetime) {
    if (empty($datetime)) {
        return '';
    }

    $timestamp = strtotime($datetime);
    $diff = time() - $timestamp;

    if ($diff < 60) {
        return 'Ø§Ù„Ø¢Ù†';
    } elseif ($diff < 3600) {
        $mins = floor($diff / 60);
        return 'Ù…Ù†Ø° ' . $mins . ' Ø¯Ù‚ÙŠÙ‚Ø©';
    } elseif ($diff < 86400) {
        $hours = floor($diff / 3600);
        return 'Ù…Ù†Ø° ' . $hours . ' Ø³Ø§Ø¹Ø©';
    } elseif ($diff < 604800) {
        $days = floor($diff / 86400);
        return 'Ù…Ù†Ø° ' . $days . ' ÙŠÙˆÙ…';
    } else {
        return todo_format_date($datetime);
    }
}

/**
 * Check if date is overdue
 */
function todo_is_overdue($dueDate, $isCompleted) {
    if ($isCompleted || empty($dueDate) || $dueDate == '0000-00-00') {
        return false;
    }

    return strtotime($dueDate) < strtotime(date('Y-m-d'));
}

/**
 * Check if date is due today
 */
function todo_is_due_today($dueDate, $isCompleted) {
    if ($isCompleted || empty($dueDate) || $dueDate == '0000-00-00') {
        return false;
    }

    return date('Y-m-d', strtotime($dueDate)) == date('Y-m-d');
}

/**
 * Get completion percentage
 */
function todo_completion_percentage($completed, $total) {
    if ($total == 0) {
        return 0;
    }

    return round(($completed / $total) * 100);
}

/**
 * Sanitize input
 */
function todo_sanitize_input($input) {
    if (is_array($input)) {
        return array_map('todo_sanitize_input', $input);
    }

    return htmlspecialchars(trim($input), ENT_QUOTES, 'UTF-8');
}

/**
 * Validate email
 */
function todo_validate_email($email) {
    return filter_var($email, FILTER_VALIDATE_EMAIL);
}

/**
 * Get user name by ID (placeholder - integrate with your user system)
 */
function todo_get_user_name($userId) {
    global $db;

    // TODO: Adjust query to match your users table structure
    $stmt = $db->prepare("SELECT username FROM users WHERE id = ?");

    if ($stmt === false) {
        return 'Ù…Ø³ØªØ®Ø¯Ù… #' . $userId;
    }

    $stmt->bind_param("i", $userId);
    $stmt->execute();
    $result = $stmt->get_result();

    if ($row = $result->fetch_assoc()) {
        return $row['username'];
    }

    return 'Ù…Ø³ØªØ®Ø¯Ù… #' . $userId;
}

/**
 * Get user email by ID (placeholder - integrate with your user system)
 */
function todo_get_user_email($userId) {
    global $db;

    // TODO: Adjust query to match your users table structure
    $stmt = $db->prepare("SELECT email FROM users WHERE id = ?");

    if ($stmt === false) {
        return '';
    }

    $stmt->bind_param("i", $userId);
    $stmt->execute();
    $result = $stmt->get_result();

    if ($row = $result->fetch_assoc()) {
        return $row['email'];
    }

    return '';
}

/**
 * Generate notification email body
 */
function todo_generate_email_body($item, $list) {
    $html = '<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ°ÙƒÙŠØ± Ø¨Ù…Ù‡Ù…Ø©</title>
</head>
<body style="font-family: Arial, sans-serif; direction: rtl; text-align: right;">
    <div style="max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f8f9fa;">
        <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 20px; border-radius: 8px 8px 0 0;">
            <h2 style="margin: 0;">ğŸ“‹ ØªØ°ÙƒÙŠØ± Ø¨Ù…Ù‡Ù…Ø©</h2>
        </div>

        <div style="background-color: white; padding: 20px; border-radius: 0 0 8px 8px;">
            <h3 style="color: #17a2b8;">' . htmlspecialchars($item['title']) . '</h3>

            <p><strong>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</strong> ' . htmlspecialchars($list['title']) . '</p>

            <p><strong>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</strong> <span style="color: ' . todo_get_priority_color($item['priority']) . ';">' . todo_get_priority_label($item['priority']) . '</span></p>

            <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</strong> ' . todo_format_date($item['due_date']) . '</p>';

    if (!empty($item['description'])) {
        $html .= '<p><strong>Ø§Ù„ÙˆØµÙ:</strong><br>' . nl2br(htmlspecialchars($item['description'])) . '</p>';
    }

    $html .= '
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                <p style="color: #6c757d; font-size: 12px; margin: 0;">
                    Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.
                </p>
            </div>
        </div>
    </div>
</body>
</html>';

    return $html;
}

/**
 * Check user permission (placeholder)
 */
function todo_check_permission($permission) {
    // For now, allow all
    // TODO: Integrate with your permission system
    return true;
}

/**
 * Log activity (placeholder)
 */
function todo_log_activity($action, $details = '') {
    // TODO: Implement activity logging
    return true;
}

/**
 * Parse tags from comma-separated string
 */
function todo_parse_tags($tagsString) {
    if (empty($tagsString)) {
        return array();
    }

    $tags = explode(',', $tagsString);
    return array_map('trim', $tags);
}

/**
 * Format tags for display
 */
function todo_format_tags($tagsString) {
    $tags = todo_parse_tags($tagsString);

    if (empty($tags)) {
        return '';
    }

    $html = '';
    foreach ($tags as $tag) {
        if (!empty($tag)) {
            $html .= '<span class="badge bg-secondary me-1">' . htmlspecialchars($tag) . '</span>';
        }
    }

    return $html;
}

/**
 * Get list color or default
 */
function todo_get_list_color($color) {
    if (empty($color)) {
        return '#17a2b8'; // Default: info color
    }

    return $color;
}

/**
 * Generate email body for entire todo list
 */
function todo_generate_list_email($list, $items) {
    // Check if list is valid
    if (!$list || !is_array($list)) {
        return '<p>Ø®Ø·Ø£: Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</p>';
    }

    // Set default values for missing keys
    $listColor = $list['color'] ?? '#17a2b8';
    $listTitle = $list['title'] ?? 'Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù…';
    $listDescription = $list['description'] ?? '';
    $totalItems = $list['total_items'] ?? 0;
    $completedItems = $list['completed_items'] ?? 0;
    $pendingItems = $list['pending_items'] ?? 0;

    $html = '<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</title>
</head>
<body style="font-family: Arial, sans-serif; direction: rtl; text-align: right; background-color: #f8f9fa; padding: 20px;">
    <div style="max-width: 800px; margin: 0 auto; background-color: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="background: linear-gradient(135deg, ' . todo_get_list_color($listColor) . ', ' . todo_get_list_color($listColor) . 'dd); color: white; padding: 30px;">
            <h1 style="margin: 0 0 10px 0; font-size: 28px;">ğŸ“‹ ' . htmlspecialchars($listTitle) . '</h1>';

    if (!empty($listDescription)) {
        $html .= '<p style="margin: 0; opacity: 0.9; font-size: 16px;">' . htmlspecialchars($listDescription) . '</p>';
    }

    $html .= '
            <div style="margin-top: 20px; display: flex; gap: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 8px;">
                    <div style="font-size: 12px; opacity: 0.9;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
                    <div style="font-size: 24px; font-weight: bold; margin-top: 5px;">' . $totalItems . '</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 8px;">
                    <div style="font-size: 12px; opacity: 0.9;">Ù…ÙƒØªÙ…Ù„Ø©</div>
                    <div style="font-size: 24px; font-weight: bold; margin-top: 5px;">' . $completedItems . '</div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 8px;">
                    <div style="font-size: 12px; opacity: 0.9;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                    <div style="font-size: 24px; font-weight: bold; margin-top: 5px;">' . $pendingItems . '</div>
                </div>
            </div>
        </div>

        <div style="padding: 30px;">';

    if (empty($items)) {
        $html .= '<p style="text-align: center; color: #6c757d; padding: 40px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>';
    } else {
        foreach ($items as $item) {
            $isCompleted = $item['is_completed'] == 1;
            $priorityColor = todo_get_priority_color($item['priority']);
            $priorityLabel = todo_get_priority_label($item['priority']);

            $html .= '
            <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: ' . ($isCompleted ? '#f8f9fa' : 'white') . ';">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                    <span style="font-size: 20px;">' . ($isCompleted ? 'âœ…' : 'â¬œ') . '</span>
                    <h3 style="margin: 0; font-size: 18px; color: #333; ' . ($isCompleted ? 'text-decoration: line-through; opacity: 0.6;' : '') . '">' . htmlspecialchars($item['title']) . '</h3>
                </div>';

            if (!empty($item['description'])) {
                $html .= '<p style="margin: 10px 0; color: #666; font-size: 14px;">' . nl2br(htmlspecialchars($item['description'])) . '</p>';
            }

            $html .= '
                <div style="display: flex; gap: 15px; margin-top: 10px; font-size: 13px;">
                    <span style="background: ' . $priorityColor . '20; color: ' . $priorityColor . '; padding: 5px 12px; border-radius: 15px; border: 1px solid ' . $priorityColor . ';">
                        Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ' . $priorityLabel . '
                    </span>';

            if (!empty($item['due_date']) && $item['due_date'] != '0000-00-00') {
                $html .= '<span style="color: #6c757d;">ğŸ“… ' . todo_format_date($item['due_date']) . '</span>';
            }

            if (!empty($item['tags'])) {
                $html .= '<span style="color: #6c757d;">ğŸ·ï¸ ' . htmlspecialchars($item['tags']) . '</span>';
            }

            $html .= '
                </div>
            </div>';
        }
    }

    $html .= '
        </div>

        <div style="background: #f8f9fa; padding: 20px; text-align: center; border-top: 1px solid #dee2e6;">
            <p style="color: #6c757d; font-size: 12px; margin: 0;">
                Ù‡Ø°Ù‡ Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ù† Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯.
            </p>
        </div>
    </div>
</body>
</html>';

    return $html;
}

/**
 * Get all users for sharing (integrate with your user system)
 */
function todo_get_all_users() {
    global $db;

    $users = array();
    $result = $db->query("SELECT userid as id, username, name FROM user WHERE userid > 0 ORDER BY username");

    if ($result) {
        while ($row = $result->fetch_assoc()) {
            $users[] = $row;
        }
    }

    return $users;
}
?>
