<?php
/**
 * Port Connectivity Test
 * Tests if specific ports are reachable on the SMTP server
 */

echo "<h1>Port Connectivity Test</h1>";

// Load mail settings
$mailsettings = @file_get_contents('../../mailsettings.cfg');

if (empty($mailsettings)) {
    die("<p style='color: red;'><strong>Error:</strong> Could not load mailsettings.cfg</p>");
}

$mailsettings = base64_decode($mailsettings);
$mailsettings = str_replace(["\r", "\n"], "", $mailsettings);
$mailsettings = explode("#", $mailsettings);

$mailhost = $mailsettings[3];

echo "<h2>Testing connectivity to: " . htmlspecialchars($mailhost) . "</h2>";

// Test common SMTP ports
$ports = [
    25 => 'SMTP (usually unencrypted)',
    465 => 'SMTPS (SSL)',
    587 => 'Submission (STARTTLS)',
    2525 => 'Alternative SMTP port'
];

echo "<table border='1' cellpadding='5' style='border-collapse: collapse;'>";
echo "<tr><th>Port</th><th>Description</th><th>Status</th><th>Time</th></tr>";

foreach ($ports as $port => $description) {
    $start = microtime(true);

    // Attempt connection with 5 second timeout
    $errno = 0;
    $errstr = '';
    $connection = @fsockopen($mailhost, $port, $errno, $errstr, 5);

    $time = round((microtime(true) - $start) * 1000, 2);

    if ($connection) {
        fclose($connection);
        echo "<tr>";
        echo "<td><strong>$port</strong></td>";
        echo "<td>$description</td>";
        echo "<td style='color: green;'><strong>✓ OPEN</strong></td>";
        echo "<td>{$time}ms</td>";
        echo "</tr>";
    } else {
        echo "<tr>";
        echo "<td><strong>$port</strong></td>";
        echo "<td>$description</td>";
        echo "<td style='color: red;'><strong>✗ BLOCKED</strong>";
        if ($errstr) {
            echo "<br><small>Error: " . htmlspecialchars($errstr) . "</small>";
        }
        echo "</td>";
        echo "<td>{$time}ms</td>";
        echo "</tr>";
    }
}

echo "</table>";

echo "<h2>Recommendations:</h2>";
echo "<ul>";
echo "<li>If <strong>ALL ports are blocked</strong>: Firewall/Antivirus is blocking PHP or all SMTP ports</li>";
echo "<li>If <strong>only port 587 is blocked</strong>: Try port 465 (SSL) or 2525</li>";
echo "<li>If <strong>connection times out (5000ms)</strong>: Network/firewall dropping packets</li>";
echo "<li>If <strong>all ports open</strong>: Issue is with SMTP authentication, not connectivity</li>";
echo "</ul>";

echo "<h2>PHP Environment:</h2>";
echo "<pre>";
echo "PHP Version: " . phpversion() . "\n";
echo "Operating System: " . PHP_OS . "\n";
echo "Server: " . $_SERVER['SERVER_SOFTWARE'] . "\n";
echo "allow_url_fopen: " . (ini_get('allow_url_fopen') ? 'Enabled' : 'Disabled') . "\n";
echo "OpenSSL: " . (extension_loaded('openssl') ? 'Enabled' : 'Disabled') . "\n";
echo "</pre>";

echo "<hr>";
echo "<p><a href='test_smtp.hnt'>Test SMTP Connection</a> | <a href='process_emails.hnt'>Back to Email Processor</a></p>";
?>
