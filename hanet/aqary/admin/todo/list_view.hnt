<?php
/**
 * TODO Module - List View
 * View and manage items in a specific list
 */

$pageTitle = 'Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…';
$sc_title = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…';
$sc_id = "88";
include_once "../../nocash.hnt";

// Load TODO module
require_once('./todo_init.hnt');

// Get list ID from URL
$listId = isset($_GET['id']) ? intval($_GET['id']) : 0;

if (!$listId) {
    header('Location: index.hnt');
    exit;
}

// Check if this is an AJAX request
$isAjax = ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['ajax_action']));

// If AJAX, use output buffering to suppress header.hnt output
if ($isAjax) {
    ob_start();
}

// Include header (needed for database connection)
$canscroll = 0;
$showdhmltazkeer = 0;
include_once "../../header.hnt";

// Initialize TodoManager (now $db is available)
$todoManager = todo_init_manager();

// Handle AJAX actions
if ($isAjax) {
    // Discard any output from header.hnt
    ob_end_clean();

    header('Content-Type: application/json; charset=utf-8');

    $action = $_POST['ajax_action'];
    $response = array('success' => false, 'message' => '');

    switch ($action) {
        case 'create_item':
            // Validate required fields
            if (empty($_POST['title'])) {
                $response['message'] = 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ù…Ø·Ù„ÙˆØ¨';
                break;
            }

            $data = array(
                'todo_list_id' => $listId,
                'title' => todo_sanitize_input($_POST['title']),
                'description' => todo_sanitize_input($_POST['description'] ?? ''),
                'priority' => $_POST['priority'] ?? 'medium',
                'due_date' => !empty($_POST['due_date']) ? $_POST['due_date'] : null,
                'assigned_to' => isset($_POST['assigned_to']) && !empty($_POST['assigned_to']) ? intval($_POST['assigned_to']) : null,
                'tags' => todo_sanitize_input($_POST['tags'] ?? ''),
                'display_order' => 0,
                'created_by' => $currentUserId
            );

            try {
                $itemId = $todoManager->createItem($data);

                // Debug logging
                error_log("TODO Debug - createItem returned: " . var_export($itemId, true));
                error_log("TODO Debug - itemId type: " . gettype($itemId));

                // Check if item was actually created by querying the database
                global $db;
                $checkStmt = $db->prepare("SELECT id FROM todo_items WHERE todo_list_id = ? ORDER BY id DESC LIMIT 1");
                $checkStmt->bind_param("i", $listId);
                $checkStmt->execute();
                $checkResult = $checkStmt->get_result();
                $lastItem = $checkResult->fetch_assoc();

                if ($lastItem) {
                    // Item was created successfully
                    $response['success'] = true;
                    $response['message'] = 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­';
                    $response['item_id'] = $lastItem['id'];
                    error_log("TODO Debug - Item created successfully with ID: " . $lastItem['id']);
                } else {
                    $response['message'] = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©';
                    if ($db && $db->error) {
                        $response['debug'] = $db->error;
                    }
                }
            } catch (Exception $e) {
                $response['message'] = 'Ø®Ø·Ø£: ' . $e->getMessage();
                error_log("TODO Error - " . $e->getMessage());
            }
            break;

        case 'toggle_item':
            $itemId = intval($_POST['item_id']);

            if ($todoManager->toggleItemCompletion($itemId)) {
                $response['success'] = true;
                $response['message'] = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©';
            } else {
                $response['message'] = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ø©';
            }
            break;

        case 'delete_item':
            $itemId = intval($_POST['item_id']);

            if ($todoManager->deleteItem($itemId)) {
                $response['success'] = true;
                $response['message'] = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­';
            } else {
                $response['message'] = 'ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©';
            }
            break;

        case 'update_item':
            $itemId = intval($_POST['item_id']);
            $data = array(
                'title' => todo_sanitize_input($_POST['title']),
                'description' => todo_sanitize_input($_POST['description'] ?? ''),
                'priority' => $_POST['priority'] ?? 'medium',
                'due_date' => $_POST['due_date'] ?? null,
                'assigned_to' => isset($_POST['assigned_to']) ? intval($_POST['assigned_to']) : null,
                'tags' => todo_sanitize_input($_POST['tags'] ?? '')
            );

            if ($todoManager->updateItem($itemId, $data)) {
                $response['success'] = true;
                $response['message'] = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­';
            } else {
                $response['message'] = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©';
            }
            break;

        case 'edit_list':
            $title = todo_sanitize_input($_POST['title'] ?? '');
            $description = todo_sanitize_input($_POST['description'] ?? '');
            $color = todo_sanitize_input($_POST['color'] ?? '#17a2b8');

            if (empty($title)) {
                $response['message'] = 'Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø·Ù„ÙˆØ¨';
                break;
            }

            $data = array(
                'title' => $title,
                'description' => $description,
                'color' => $color,
                'shared_with' => $list['shared_with'],
                'is_active' => $list['is_active']
            );

            if ($todoManager->updateList($listId, $data)) {
                $response['success'] = true;
                $response['message'] = 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­';
            } else {
                $response['message'] = 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
            }
            break;

        case 'share_list':
            $sharedWith = todo_sanitize_input($_POST['shared_with'] ?? '');
            $data = array(
                'title' => $list['title'],
                'description' => $list['description'],
                'shared_with' => $sharedWith,
                'color' => $list['color'],
                'is_active' => $list['is_active']
            );

            if ($todoManager->updateList($listId, $data)) {
                $response['success'] = true;
                $response['message'] = 'ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­';
            } else {
                $response['message'] = 'ÙØ´Ù„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
            }
            break;

        case 'send_email':
            // Get email addresses
            $emailTo = todo_sanitize_input($_POST['email_to'] ?? '');

            if (empty($emailTo)) {
                $response['message'] = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø·Ù„ÙˆØ¨';
                break;
            }

            try {
                global $db;

                // Fetch list and items before generating email
                $list = $todoManager->getList($listId);
                $items = $todoManager->getListItems($listId);

                if (!$list) {
                    $response['message'] = 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
                    break;
                }

                // Check if table exists, if not create it WITHOUT foreign key
                $tableCheck = $db->query("SHOW TABLES LIKE 'todo_mail_queue'");
                if ($tableCheck->num_rows == 0) {
                    // Create the table WITHOUT foreign key constraint
                    $createTable = "CREATE TABLE `todo_mail_queue` (
                        `id` int(11) NOT NULL AUTO_INCREMENT,
                        `todo_item_id` int(11) DEFAULT NULL COMMENT 'Optional reference to todo_items.id (no constraint)',
                        `user_id` int(11) NOT NULL,
                        `email_to` varchar(500) NOT NULL,
                        `subject` varchar(500) NOT NULL,
                        `body` text NOT NULL,
                        `is_sent` tinyint(1) DEFAULT 0,
                        `sent_at` datetime DEFAULT NULL,
                        `retry_count` int(11) DEFAULT 0,
                        `last_error` text DEFAULT NULL,
                        `created_at` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
                        PRIMARY KEY (`id`),
                        KEY `user_id` (`user_id`),
                        KEY `is_sent` (`is_sent`),
                        KEY `todo_item_id` (`todo_item_id`)
                    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4";

                    if (!$db->query($createTable)) {
                        $response['message'] = 'ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯: ' . $db->error;
                        error_log("TODO: Failed to create todo_mail_queue table: " . $db->error);
                        break;
                    }
                }

                // Generate email content
                $emailSubject = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…: ' . $list['title'];
                $emailBody = todo_generate_list_email($list, $items);

                // Insert directly into database to avoid any issues
                $stmt = $db->prepare("INSERT INTO todo_mail_queue (todo_item_id, user_id, email_to, subject, body) VALUES (?, ?, ?, ?, ?)");

                if (!$stmt) {
                    $response['message'] = 'ÙØ´Ù„ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…: ' . $db->error;
                    error_log("TODO Email: Prepare failed - " . $db->error);
                    break;
                }

                $itemId = 0;
                $stmt->bind_param("iisss", $itemId, $currentUserId, $emailTo, $emailSubject, $emailBody);

                if ($stmt->execute()) {
                    $response['success'] = true;
                    $response['message'] = 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
                    error_log("TODO Email: Successfully queued email ID " . $db->insert_id);
                } else {
                    $response['message'] = 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±ÙŠØ¯: ' . $stmt->error;
                    error_log("TODO Email: Execute failed - " . $stmt->error);
                }

                $stmt->close();

            } catch (Exception $e) {
                $response['message'] = 'Ø®Ø·Ø£: ' . $e->getMessage();
                error_log("TODO Email Error: " . $e->getMessage());
            }
            break;
    }

    echo json_encode($response, JSON_UNESCAPED_UNICODE);
    exit;
}

// Get list details
$list = $todoManager->getList($listId);

if (!$list) {
    die('Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
}

// Check user permissions
$hasAccess = false;
if ($list['user_id'] == $currentUserId) {
    $hasAccess = true;
} elseif (!empty($list['shared_with'])) {
    $sharedUsers = explode(',', $list['shared_with']);
    if (in_array($currentUserId, $sharedUsers)) {
        $hasAccess = true;
    }
}

if (!$hasAccess) {
    die('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
}

// Get items in this list
$items = $todoManager->getListItems($listId);

// Get all users for sharing
$allUsers = todo_get_all_users();

// Get currently shared users
$sharedUserIds = !empty($list['shared_with']) ? explode(',', $list['shared_with']) : array();

// Temporary debug output (remove after testing)
if (isset($_GET['debug'])) {
    echo "<pre style='background: #f0f0f0; padding: 20px; border: 2px solid #ccc; margin: 20px;'>";
    echo "List ID: $listId\n";
    echo "Total items found: " . count($items) . "\n\n";
    echo "List data:\n";
    print_r($list);
    echo "\n\nItems data:\n";
    print_r($items);
    echo "</pre>";
}
?>

 

<style>
<?php
// Ensure we have a valid color
$listColor = todo_get_list_color($list['color']);
?>
:root {
    --list-color: <?php echo $listColor; ?>;
    --list-color-light: <?php echo $listColor . '20'; ?>;
}

.list-header {
    background: linear-gradient(135deg, var(--list-color), <?php echo $listColor; ?>dd);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
}

.list-header h2 {
    margin: 0 0 10px 0;
    font-size: 2rem;
}

.list-header .description {
    opacity: 0.9;
    margin: 0;
}

.list-stats {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.2);
    padding: 10px 20px;
    border-radius: 10px;
    backdrop-filter: blur(10px);
}

.stat-item .label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.stat-item .value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-top: 5px;
}

.item-row {
    display: flex;
    align-items: center;
    gap: 12px;
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 14px 16px;
    margin-bottom: 8px;
    transition: all 0.2s;
    cursor: pointer;
}

.item-row:hover {
    background: #f8f9fa;
    border-color: #dee2e6;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.item-row.completed {
    background: #f8f9fa;
}

.item-row.completed .item-title-text {
    text-decoration: line-through;
    color: #6c757d;
}

.item-checkbox-wrapper {
    display: flex;
    align-items: center;
    flex-shrink: 0;
}

.item-checkbox-input {
    width: 22px;
    height: 22px;
    cursor: pointer;
    accent-color: var(--list-color);
    border-radius: 4px;
}

.item-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-width: 0;
    gap: 4px;
}

.item-title-text {
    font-size: 0.95rem;
    color: #212529;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

.item-description-text {
    font-size: 0.8rem;
    color: #6c757d;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
    font-weight: 400;
}

.priority-badge-compact {
    padding: 4px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    white-space: nowrap;
    flex-shrink: 0;
}

.priority-high {
    background: #ffc107;
    color: white;
    border: none;
}

.priority-medium {
    background: #28a745;
    color: white;
    border: none;
}

.priority-low {
    background: #17a2b8;
    color: white;
    border: none;
}

.item-date {
    font-size: 0.85rem;
    color: #6c757d;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
    padding: 4px 12px;
    background: #f8f9fa;
    border-radius: 6px;
}

.item-date i {
    font-size: 0.9rem;
}

.item-actions-compact {
    display: flex;
    gap: 4px;
    align-items: center;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.2s;
}

.item-row:hover .item-actions-compact {
    opacity: 1;
}

.btn-icon {
    background: transparent;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 5px;
    transition: all 0.2s;
    font-size: 1rem;
}

.btn-icon:hover {
    background: #dc3545;
    color: white;
}

.btn-icon.edit-btn {
    color: #0d6efd;
}

.btn-icon.edit-btn:hover {
    background: #0d6efd;
    color: white;
}

.btn-icon.delete-btn {
    color: #dc3545;
}

.btn-icon.delete-btn:hover {
    background: #dc3545;
    color: white;
}

.add-item-card {
    background: var(--list-color-light);
    border: 2px dashed var(--list-color);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 30px;
    cursor: pointer;
    text-align: center;
    transition: all 0.3s;
}

.add-item-card:hover {
    background: var(--list-color);
    color: white;
}

.add-item-card i {
    font-size: 2rem;
    margin-bottom: 10px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

.items-container {
    background: transparent;
    padding: 0;
}

/* Smooth checkbox animation */
.item-checkbox-input {
    transition: all 0.2s ease;
}

.item-checkbox-input:checked {
    transform: scale(1.1);
}

/* Better row interaction */
.item-row {
    user-select: none;
}

.item-row:active {
    transform: scale(0.995);
}

.overdue {
    color: #dc3545 !important;
    font-weight: bold;
}

.due-today {
    color: #ffc107 !important;
    font-weight: bold;
}

/* Enhanced animations */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.item-row {
    animation: slideInUp 0.3s ease-out;
}

.add-item-card {
    transition: all 0.3s ease;
}

.add-item-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
}

/* Improved buttons */
.btn-light {
    transition: all 0.3s ease;
}

.btn-light:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* Better modal styling */
.modal-content {
    border-radius: 15px;
    overflow: hidden;
}

.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: none;
    padding-top: 0;
}

/* Enhanced form controls */
.form-control:focus,
.form-select:focus {
    border-color: var(--list-color);
    box-shadow: 0 0 0 0.25rem rgba(var(--list-color-rgb), 0.25);
}
</style>

<div class="container mt-4">
    <!-- List Header -->
    <div class="list-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2><i class="bi bi-list-task me-2"></i><?php echo htmlspecialchars($list['title']); ?></h2>
                <?php if (!empty($list['description'])): ?>
                    <p class="description"><?php echo htmlspecialchars($list['description']); ?></p>
                <?php endif; ?>

                <div class="list-stats">
                    <div class="stat-item">
                        <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
                        <div class="value"><?php echo $list['total_items']; ?></div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Ù…ÙƒØªÙ…Ù„Ø©</div>
                        <div class="value"><?php echo $list['completed_items']; ?></div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                        <div class="value"><?php echo $list['pending_items']; ?></div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editListModal" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <i class="bi bi-pencil-square"></i> ØªØ¹Ø¯ÙŠÙ„
                </button>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#shareModal" title="Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">
                    <i class="bi bi-share"></i> Ù…Ø´Ø§Ø±ÙƒØ©
                </button>
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#emailModal" title="Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯">
                    <i class="bi bi-envelope"></i> Ø¥Ø±Ø³Ø§Ù„
                </button>
                <a href="index.hnt" class="btn btn-secondary">
                    <i class="bi bi-arrow-right me-2"></i>Ø§Ù„Ø¹ÙˆØ¯Ø©
                </a>
            </div>
        </div>
    </div>

    <!-- Add Item Card -->
    <div class="add-item-card" data-bs-toggle="modal" data-bs-target="#createItemModal">
        <i class="bi bi-plus-circle-fill" style="font-size: 2.5rem;"></i>
        <h5>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
    </div>

    <!-- Items List -->
    <?php if (count($items) > 0): ?>
        <div class="items-container">
            <?php foreach ($items as $item): ?>
                <?php
                $isCompleted = $item['is_completed'] == 1;
                $isOverdue = todo_is_overdue($item['due_date'], $isCompleted);
                $isDueToday = todo_is_due_today($item['due_date'], $isCompleted);
                $priorityClass = 'priority-' . $item['priority'];
                ?>

                <div class="item-row <?php echo $isCompleted ? 'completed' : ''; ?>"
                     data-item-id="<?php echo $item['id']; ?>"
                     onclick="toggleItemByRow(<?php echo $item['id']; ?>, event)">

                    <div class="item-checkbox-wrapper" onclick="event.stopPropagation();">
                        <input type="checkbox"
                               class="item-checkbox-input"
                               id="item_<?php echo $item['id']; ?>"
                               <?php echo $isCompleted ? 'checked' : ''; ?>
                               onchange="toggleItem(<?php echo $item['id']; ?>)">
                    </div>

                    <div class="item-content">
                        <span class="item-title-text">
                            <?php echo htmlspecialchars($item['title']); ?>
                        </span>
                        <?php if (!empty($item['description'])): ?>
                            <span class="item-description-text">
                                <?php echo htmlspecialchars($item['description']); ?>
                            </span>
                        <?php endif; ?>
                    </div>

                    <span class="priority-badge-compact <?php echo $priorityClass; ?>">
                        <?php echo todo_get_priority_label($item['priority']); ?>
                    </span>

                    <span class="item-date">
                        <i class="bi bi-calendar3"></i>
                        <?php
                        if (!empty($item['due_date']) && $item['due_date'] != '0000-00-00') {
                            echo todo_format_date($item['due_date']);
                        } else {
                            echo todo_format_date($item['created_at']);
                        }
                        ?>
                    </span>

                    <div class="item-actions-compact" onclick="event.stopPropagation();">
                        <button class="btn-icon edit-btn" onclick="editItem(<?php echo $item['id']; ?>, '<?php echo htmlspecialchars(addslashes($item['title'])); ?>', '<?php echo htmlspecialchars(addslashes($item['description'])); ?>', '<?php echo $item['priority']; ?>', '<?php echo $item['due_date']; ?>', '<?php echo htmlspecialchars(addslashes($item['tags'])); ?>')" title="ØªØ¹Ø¯ÙŠÙ„">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-icon delete-btn" onclick="deleteItem(<?php echo $item['id']; ?>); return false;" title="Ø­Ø°Ù">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    <?php else: ?>
        <div class="empty-state">
            <i class="bi bi-clipboard2-x" style="font-size: 5rem;"></i>
            <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø¨Ø¹Ø¯</h4>
            <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</p>
        </div>
    <?php endif; ?>
</div>

<!-- Create Item Modal -->
<div class="modal fade" id="createItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--list-color); color: white;">
                <h5 class="modal-title"><i class="bi bi-plus-circle-fill me-2"></i>Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createItemForm">
                    <div class="mb-3">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
                        <input type="text" class="form-control" name="title" required
                               placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <textarea class="form-control" name="description" rows="3"
                                  placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©..."></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                            <select class="form-select" name="priority">
                                <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                                <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                            <input type="date" class="form-control" name="due_date">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØ³ÙˆÙ… (Tags)</label>
                        <input type="text" class="form-control" name="tags"
                               placeholder="Ø¹Ø§Ø¬Ù„ØŒ Ù…Ù‡Ù…ØŒ Ø¹Ù‚ÙˆØ¯ (Ø§ÙØµÙ„ Ø¨ÙØ§ØµÙ„Ø©)">
                        <small class="form-text text-muted">Ø§ÙØµÙ„ Ø§Ù„ÙˆØ³ÙˆÙ… Ø¨ÙØ§ØµÙ„Ø©</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateItem()">
                    <i class="bi bi-check-circle me-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--list-color); color: white;">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    <input type="hidden" name="item_id" id="edit_item_id">

                    <div class="mb-3">
                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
                        <input type="text" class="form-control" name="title" id="edit_title" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <textarea class="form-control" name="description" id="edit_description" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                            <select class="form-select" name="priority" id="edit_priority">
                                <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                                <option value="medium">Ù…ØªÙˆØ³Ø·Ø©</option>
                                <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                            </select>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                            <input type="date" class="form-control" name="due_date" id="edit_due_date">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØ³ÙˆÙ… (Tags)</label>
                        <input type="text" class="form-control" name="tags" id="edit_tags">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitEditItem()">
                    <i class="bi bi-check-circle me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function submitCreateItem() {
    const form = document.getElementById('createItemForm');
    const formData = new FormData(form);
    formData.append('ajax_action', 'create_item');

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response:', data);
        if (data.success) {
            // Reset the form
            form.reset();

            // Close the modal using jQuery (since jQuery 3 is available)
            const $modal = $('#createItemModal');
            if ($modal.length) {
                // Hide modal, then reload after it's fully hidden
                $modal.one('hidden.bs.modal', function () {
                    location.reload();
                });
                $modal.modal('hide');
            } else {
                // If modal not found, just reload
                location.reload();
            }
        } else {
            let errorMsg = data.message;
            if (data.debug) {
                console.error('Database error:', data.debug);
                errorMsg += '\n\nØ®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø±Ø§Ø¬Ø¹ Console)';
            }
            alert(errorMsg);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©');
    });
}

function toggleItem(itemId) {
    const formData = new FormData();
    formData.append('ajax_action', 'toggle_item');
    formData.append('item_id', itemId);

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©');
    });
}

function toggleItemByRow(itemId, event) {
    // Don't toggle if clicking on checkbox, buttons, or links
    if (event.target.closest('.item-checkbox-wrapper') ||
        event.target.closest('.item-actions-compact') ||
        event.target.tagName === 'A' ||
        event.target.tagName === 'BUTTON') {
        return;
    }

    // Toggle the checkbox
    const checkbox = document.getElementById('item_' + itemId);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        toggleItem(itemId);
    }
}

function deleteItem(itemId) {
    event.stopPropagation();
    event.preventDefault();

    // Store itemId for the confirm modal
    window.deleteItemId = itemId;

    // Show Bootstrap confirmation modal
    const confirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    confirmModal.show();

    return false;
}

function confirmDeleteItem() {
    const itemId = window.deleteItemId;

    // Hide the modal
    const confirmModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
    confirmModal.hide();

    const formData = new FormData();
    formData.append('ajax_action', 'delete_item');
    formData.append('item_id', itemId);

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResultModal(true, 'ØªÙ… Ø§Ù„Ø­Ø°Ù', data.message, true);
        } else {
            showResultModal(false, 'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResultModal(false, 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©');
    });
}

function editItem(itemId, title, description, priority, dueDate, tags) {
    event.stopPropagation();
    event.preventDefault();

    // Populate the edit form
    document.getElementById('edit_item_id').value = itemId;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_priority').value = priority;
    document.getElementById('edit_due_date').value = dueDate && dueDate !== '0000-00-00' ? dueDate : '';
    document.getElementById('edit_tags').value = tags;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
    modal.show();

    return false;
}

function submitEditItem() {
    const form = document.getElementById('editItemForm');
    const formData = new FormData(form);
    formData.append('ajax_action', 'update_item');

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResultModal(true, 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', data.message, true);
        } else {
            showResultModal(false, 'ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResultModal(false, 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©');
    });
}

function submitShare() {
    // Get all checked user IDs
    const checkboxes = document.querySelectorAll('input[name="shared_users[]"]:checked');
    const selectedUserIds = Array.from(checkboxes).map(cb => cb.value);

    // Create form data
    const formData = new FormData();
    formData.append('ajax_action', 'share_list');
    formData.append('shared_with', selectedUserIds.join(','));

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#shareModal').modal('hide');
            showResultModal(true, 'ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', data.message, true);
        } else {
            showResultModal(false, 'ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResultModal(false, 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
    });
}

function submitEmail() {
    const form = document.getElementById('emailForm');
    const formData = new FormData(form);
    formData.append('ajax_action', 'send_email');

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#emailModal').modal('hide');
            form.reset();
            showResultModal(true, 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', data.message);
        } else {
            showResultModal(false, 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResultModal(false, 'Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯');
    });
}

function submitEditList() {
    const form = document.getElementById('editListForm');
    const formData = new FormData(form);
    formData.append('ajax_action', 'edit_list');

    fetch('list_view.hnt?id=<?php echo $listId; ?>', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
    });
}
</script>

<!-- Edit List Modal -->
<div class="modal fade" id="editListModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--list-color); color: white;">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editListForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© *</label>
                        <input type="text" class="form-control" name="title" required
                               value="<?php echo htmlspecialchars($list['title']); ?>">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„ÙˆØµÙ</label>
                        <textarea class="form-control" name="description" rows="3"><?php echo htmlspecialchars($list['description'] ?? ''); ?></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ù„ÙˆÙ†</label>
                        <input type="color" class="form-control form-control-color" name="color"
                               value="<?php echo htmlspecialchars($list['color'] ?? '#17a2b8'); ?>">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitEditList()">
                    <i class="bi bi-check-circle me-2"></i>Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--list-color); color: white;">
                <h5 class="modal-title"><i class="bi bi-share me-2"></i>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="shareForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="bi bi-people me-2"></i>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                        </label>

                        <?php if (empty($allUsers)): ?>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                            </div>
                        <?php else: ?>
                            <!-- Search Box -->
                            <div class="mb-3">
                                <input type="text" class="form-control" id="userSearch"
                                       placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
                                       onkeyup="filterUsers()">
                            </div>

                            <!-- Users List -->
                            <div class="users-list-container" style="max-height: 300px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 8px; padding: 10px;">
                                <?php foreach ($allUsers as $user): ?>
                                    <?php
                                        $isChecked = in_array($user['id'], $sharedUserIds) ? 'checked' : '';
                                        $userName = htmlspecialchars($user['username']);
                                        $userEmail = htmlspecialchars($user['email'] ?? '');
                                    ?>
                                    <div class="user-item form-check p-3 mb-2" style="background: #f8f9fa; border-radius: 8px; transition: all 0.3s;"
                                         onmouseover="this.style.background='#e9ecef'"
                                         onmouseout="this.style.background='#f8f9fa'">
                                        <input class="form-check-input" type="checkbox"
                                               name="shared_users[]"
                                               value="<?php echo $user['id']; ?>"
                                               id="user_<?php echo $user['id']; ?>"
                                               <?php echo $isChecked; ?>>
                                        <label class="form-check-label w-100" for="user_<?php echo $user['id']; ?>" style="cursor: pointer;">
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <i class="bi bi-person-circle" style="font-size: 2rem; color: #17a2b8;"></i>
                                                </div>
                                                <div>
                                                    <div class="fw-bold"><?php echo $userName; ?></div>
                                                    <?php if ($userEmail): ?>
                                                        <small class="text-muted">
                                                            <i class="bi bi-envelope me-1"></i><?php echo $userEmail; ?>
                                                        </small>
                                                    <?php endif; ?>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                <?php endforeach; ?>
                            </div>

                            <!-- Select All / Deselect All -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllUsers()">
                                    <i class="bi bi-check-all me-1"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllUsers()">
                                    <i class="bi bi-x-circle me-1"></i>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                                </button>
                            </div>
                        <?php endif; ?>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø³ÙŠØªÙ…ÙƒÙ†ÙˆÙ† Ù…Ù† Ø¹Ø±Ø¶ ÙˆØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ…Ù‡Ø§Ù…Ù‡Ø§.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Ø¥Ù„ØºØ§Ø¡
                </button>
                <button type="button" class="btn btn-primary" onclick="submitShare()">
                    <i class="bi bi-check-circle me-2"></i>Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Filter users by search
function filterUsers() {
    const searchValue = document.getElementById('userSearch').value.toLowerCase();
    const userItems = document.querySelectorAll('.user-item');

    userItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchValue)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// Select all users
function selectAllUsers() {
    const checkboxes = document.querySelectorAll('input[name="shared_users[]"]');
    checkboxes.forEach(cb => {
        if (cb.closest('.user-item').style.display !== 'none') {
            cb.checked = true;
        }
    });
}

// Deselect all users
function deselectAllUsers() {
    const checkboxes = document.querySelectorAll('input[name="shared_users[]"]');
    checkboxes.forEach(cb => cb.checked = false);
}
</script>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--list-color); color: white;">
                <h5 class="modal-title"><i class="bi bi-envelope me-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
                        <input type="email" class="form-control" name="email_to" required
                               placeholder="example@domain.com">
                        <small class="form-text text-muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ø±ÙŠØ¯ Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©</small>
                    </div>

                    <div class="alert alert-success">
                        <i class="bi bi-info-circle me-2"></i>
                        Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" onclick="submitEmail()">
                    <i class="bi bi-send me-2"></i>Ø¥Ø±Ø³Ø§Ù„
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-trash" style="font-size: 3rem; color: #dc3545;"></i>
                <h5 class="mt-3">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ</h5>
                <p class="text-muted">Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Ø¥Ù„ØºØ§Ø¡
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteItem()">
                    <i class="bi bi-trash me-2"></i>Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; border: none;">
            <div class="modal-header" id="modalHeader" style="border-radius: 15px 15px 0 0; border: none;">
                <h5 class="modal-title text-white" id="modalTitle">
                    <i class="bi me-2" id="modalIcon"></i>
                    <span id="modalTitleText"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <p id="modalMessage" style="font-size: 1.1rem; margin: 0;"></p>
            </div>
            <div class="modal-footer" style="border: none; padding: 20px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Ø¥ØºÙ„Ø§Ù‚
                </button>
                <button type="button" class="btn btn-primary" id="modalReloadBtn" style="display: none;" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise me-2"></i>ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Show result modal
function showResultModal(success, title, message, autoReload = false) {
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const modalHeader = document.getElementById('modalHeader');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitleText = document.getElementById('modalTitleText');
    const modalMessage = document.getElementById('modalMessage');
    const modalReloadBtn = document.getElementById('modalReloadBtn');

    if (success) {
        modalHeader.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
        modalIcon.className = 'bi bi-check-circle-fill me-2';
        modalTitleText.textContent = title || 'Ù†Ø¬Ø­Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
    } else {
        modalHeader.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
        modalIcon.className = 'bi bi-x-circle-fill me-2';
        modalTitleText.textContent = title || 'ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
    }

    modalMessage.textContent = message;

    // Show reload button if needed
    if (autoReload && success) {
        modalReloadBtn.style.display = 'inline-block';
    } else {
        modalReloadBtn.style.display = 'none';
    }

    modal.show();

    // Auto reload after 2 seconds if success and autoReload is true
    if (success && autoReload) {
        setTimeout(() => {
            location.reload();
        }, 2000);
    }
}
</script>

<?php
require("../../footer.hnt");
?>
