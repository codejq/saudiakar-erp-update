<?php
/**
 * File Management System - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
 * Integrated with Legacy Real Estate System
 *
 * @charset UTF-8
 * @version 2.0
 */

$sc_title = "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª";
$sc_id = "201";
include_once "../../nocash.hnt";

$canscroll = 0;
$showdhmltazkeer = 0;
include_once "../../header.hnt";

// Include legacy system database connection
require_once('../../connectdb.hnt');

// Include library classes
require_once('lib/DatabaseInstaller.class.php');
require_once('lib/SharingManager.class.php');
require_once('lib/FileHandler.class.php');
require_once('lib/PreviewHandler.class.php');

// Get current user from session
$currentUserId = $_SESSION['useridv'] ?? 1;
$currentUsername = $_SESSION['usernamev'] ?? 'Admin';

// Initialize database - use $link (wrapper connection) from connectdb.hnt
$installer = new DatabaseInstaller($link);

// Check if tables exist, if not show installation wizard
if (!$installer->tablesExist()) {
    if (isset($_POST['install_confirmed'])) {
        // Clear any previous output
        ob_end_clean();
        ob_start();

        header('Content-Type: application/json; charset=utf-8');
        try {
            $result = $installer->installTables();
            error_log("Installation result: " . json_encode($result));

            // installTables() now returns an array with success/message
            if (is_array($result)) {
                $response = [
                    'success' => $result['success'],
                    'message' => $result['message']
                ];
                http_response_code($result['success'] ? 200 : 500);
            } else {
                // Fallback for old return value
                $response = [
                    'success' => $result,
                    'message' => $result ? 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­' : 'ÙØ´Ù„ Ø§Ù„ØªØ«Ø¨ÙŠØª'
                ];
            }

            $json_output = json_encode($response, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
            error_log("JSON output: " . $json_output);
            echo $json_output;

        } catch (Exception $e) {
            error_log("Installation exception: " . $e->getMessage());
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª: ' . $e->getMessage()
            ], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
        }
        ob_end_flush();
        exit;
    }
    // Only initialize directories if not posting installation
    $installer->createDirectories();
    // Show installation wizard
    if (file_exists('lib/installation-wizard.html')) {
        include_once('lib/installation-wizard.html');
    } else {
        // Simple installation form if wizard doesn't exist
        ?>
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ØªØ«Ø¨ÙŠØª Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª</title>

            <style>
                body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; }
                .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 500px; }
                h2 { color: #667eea; text-align: center; margin-bottom: 30px; }
                p { text-align: center; color: #666; margin-bottom: 30px; }
                .btn { width: 100%; padding: 12px; font-size: 16px; }
            </style>
        </head>
        <body>
            <div class="container">
                <h2>ğŸ”§ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</h2>
                <p>ÙŠØªØ·Ù„Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… ØªØ«Ø¨ÙŠØª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
                <form method="POST">
                    <button type="submit" name="install_confirmed" value="1" class="btn btn-primary">
                        <i class="bi bi-gear"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù†
                    </button>
                </form>
                <hr>
                <p style="font-size: 12px; color: #999; margin-top: 20px;">
                    Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
                </p>
            </div>
        </body>
        </html>
        <?php
    }
    exit;
}
?>
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</title>

    <style>
        /* Scoped styles for file management module only */
        .file-management-container {
            background: #f5f7fa;
            min-height: calc(100vh - 100px);
            padding: 20px;
        }

        .file-management-container .main-container {
            display: flex;
            gap: 0;
            background: #f5f7fa;
        }

        .file-management-container .sidebar {
            width: 250px;
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
            border-radius: 10px;
            margin-left: 20px;
        }

        .file-management-container .sidebar-section {
            margin-bottom: 30px;
        }

        .file-management-container .sidebar-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            text-transform: uppercase;
            margin-bottom: 15px;
            padding-right: 10px;
            border-right: 3px solid #667eea;
        }

        .file-management-container .sidebar-item {
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .file-management-container .sidebar-item:hover {
            background: #f0f0f0;
            color: #333;
        }

        .file-management-container .sidebar-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .file-management-container .sidebar-item i {
            margin-left: 10px;
        }

        .file-management-container .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px;
        }

        .file-management-container .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .file-management-container .header-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .file-management-container .action-buttons {
            display: flex;
            gap: 10px;
        }

        .file-management-container .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-management-container .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
            text-decoration: none;
        }

        .file-management-container .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .file-management-container .btn-secondary:hover {
            background: #d0d0d0;
            color: #333;
        }

        .file-management-container .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-management-container .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }

        .file-management-container .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
        }

        .file-management-container .stat-label {
            color: #666;
            font-size: 14px;
        }

        .file-management-container .upload-area {
            background: white;
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-management-container .upload-area:hover {
            background: #f5f7fa;
            border-color: #764ba2;
        }

        .file-management-container .upload-area.dragover {
            background: #f0f0f0;
            border-color: #764ba2;
        }

        .file-management-container .upload-icon {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .file-management-container .upload-text {
            font-size: 16px;
            color: #333;
            margin-bottom: 5px;
        }

        .file-management-container .upload-subtext {
            font-size: 12px;
            color: #666;
        }

        .file-management-container .file-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .file-management-container .file-list-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 150px;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }

        .file-management-container .file-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 150px;
            gap: 20px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: all 0.3s ease;
        }

        .file-management-container .file-item:hover {
            background: #f8f9fa;
        }

        .file-management-container .file-name {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .file-management-container .file-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        .file-management-container .file-actions {
            display: flex;
            gap: 8px;
        }

        .file-management-container .file-action-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .file-management-container .file-action-btn:hover {
            background: #f0f0f0;
            color: #764ba2;
        }

        .file-management-container .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .file-management-container .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .file-management-container .empty-state-text {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .file-management-container .empty-state-subtext {
            font-size: 14px;
            color: #bbb;
        }

        /* File Card Styles for Grid View */
        .file-management-container .file-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
        }

        .file-management-container .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .file-management-container .file-card-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .file-management-container .file-card-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .file-management-container .file-card-info {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            color: #666;
            font-size: 12px;
        }

        .file-management-container .file-card-actions {
            display: flex;
            justify-content: center;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .file-management-container .file-card:hover .file-card-actions {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .file-management-container .main-container {
                flex-direction: column;
            }

            .file-management-container .sidebar {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid #e0e0e0;
                margin-left: 0;
                margin-bottom: 20px;
            }

            .file-management-container .file-list-header,
            .file-management-container .file-item {
                grid-template-columns: 1fr;
            }

            .file-management-container .action-buttons {
                flex-direction: column;
            }

            .file-management-container .btn-action {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<!-- File Management Container - Scoped Styles -->
<div class="file-management-container">
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„ÙØ¦Ø§Øª</div>
                <div class="sidebar-item active" onclick="filterByCategory('all')">
                    <i class="bi bi-folder"></i>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Personal')">
                    <i class="bi bi-person"></i>Ø´Ø®ØµÙŠ
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Work')">
                    <i class="bi bi-briefcase"></i>Ø§Ù„Ø¹Ù…Ù„
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Projects')">
                    <i class="bi bi-diagram-2"></i>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Reports')">
                    <i class="bi bi-file-earmark-text"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Contracts')">
                    <i class="bi bi-file-earmark-pdf"></i>Ø§Ù„Ø¹Ù‚ÙˆØ¯
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Invoices')">
                    <i class="bi bi-receipt"></i>Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                </div>
                <div class="sidebar-item" onclick="filterByCategory('Proposals')">
                    <i class="bi bi-star"></i>Ø§Ù„Ø¹Ø±ÙˆØ¶
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</div>
                <div class="sidebar-item" onclick="showSharedWithMe()">
                    <i class="bi bi-share2"></i>Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ÙŠ
                </div>
                <div class="sidebar-item" onclick="showRecycleBin()">
                    <i class="bi bi-trash"></i>Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Header Section with Search and Filter -->
            <div class="header-section">
                <div style="flex: 1;">
                    <div class="header-title" id="pageTitle">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
                </div>
                <div class="action-buttons">
                    <button class="btn-action" onclick="showUploadModal()">
                        <i class="bi bi-cloud-arrow-up"></i>ØªØ­Ù…ÙŠÙ„
                    </button>
                    <button class="btn-action btn-secondary" id="viewToggleBtn" onclick="toggleListView()">
                        <i class="bi bi-grid-3x3-gap"></i>Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ©
                    </button>
                    <button class="btn-action btn-secondary" onclick="toggleSearchFilters()">
                        <i class="bi bi-funnel"></i>Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
                    </button>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div id="searchFilterSection" style="display: none; background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù„ÙØ§Øª:</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„ÙˆØµÙ" onkeyup="debounceSearch()">
                    </div>
                    <div>
                        <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù:</label>
                        <select id="fileTypeFilter" class="form-control" onchange="applyFilters()">
                            <option value="">-- Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ --</option>
                            <option value="pdf">PDF</option>
                            <option value="doc,docx">Word</option>
                            <option value="xls,xlsx">Excel</option>
                            <option value="jpg,jpeg,png,gif">Ø§Ù„ØµÙˆØ±</option>
                            <option value="zip,rar">Ø£Ø±Ø´ÙŠÙØ§Øª</option>
                            <option value="mp4,avi,mov">Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</option>
                            <option value="mp3,wav">Ø§Ù„ØµÙˆØª</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
                        <select id="sortByFilter" class="form-control" onchange="applyFilters()">
                            <option value="created_date">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
                            <option value="created_date-asc">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
                            <option value="filename">Ø§Ù„Ø§Ø³Ù… (Ø£-ÙŠ)</option>
                            <option value="filename-desc">Ø§Ù„Ø§Ø³Ù… (ÙŠ-Ø£)</option>
                            <option value="file_size">Ø§Ù„Ø­Ø¬Ù… (Ø§Ù„Ø£ØµØºØ± Ø£ÙˆÙ„Ø§Ù‹)</option>
                            <option value="file_size-desc">Ø§Ù„Ø­Ø¬Ù… (Ø§Ù„Ø£ÙƒØ¨Ø± Ø£ÙˆÙ„Ø§Ù‹)</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <label class="form-label">Ù…Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="dateFromFilter" class="form-control" onchange="applyFilters()">
                    </div>
                    <div>
                        <label class="form-label">Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="dateToFilter" class="form-control" onchange="applyFilters()">
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="applyFilters()" style="flex: 1;">ØªØ·Ø¨ÙŠÙ‚</button>
                        <button class="btn btn-sm btn-secondary" onclick="clearFilters()" style="flex: 1;">Ù…Ø³Ø­</button>
                    </div>
                </div>
            </div>

            <!-- Bulk Operations Section -->
            <div id="bulkOperationsSection" style="display: none; background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong>ØªÙ… ØªØ­Ø¯ÙŠØ¯ <span id="selectedCount">0</span> Ù…Ù„ÙØ§Øª</strong>
                </div>
                <div class="action-buttons" style="margin: 0;">
                    <button class="btn-action btn-secondary" onclick="selectAllFiles()">
                        <i class="bi bi-check-square"></i>ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„
                    </button>
                    <button class="btn-action btn-secondary" onclick="deselectAllFiles()">
                        <i class="bi bi-square"></i>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯
                    </button>
                    <button class="btn-action" onclick="bulkShareFiles()">
                        <i class="bi bi-share2"></i>Ù…Ø´Ø§Ø±ÙƒØ©
                    </button>
                    <button class="btn-action" style="background: #e74c3c;" onclick="bulkDeleteFiles()">
                        <i class="bi bi-trash"></i>Ø­Ø°Ù
                    </button>
                </div>
            </div>

            <!-- Stats Section -->
            <div class="stats-section">
                <div class="stat-card">
                    <i class="bi bi-file-earmark" style="font-size: 32px; color: #667eea;"></i>
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª</div>
                </div>
                <div class="stat-card">
                    <i class="bi bi-cloud" style="font-size: 32px; color: #667eea;"></i>
                    <div class="stat-number" id="totalSize">0 MB</div>
                    <div class="stat-label">Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
                </div>
                <div class="stat-card">
                    <i class="bi bi-share2" style="font-size: 32px; color: #667eea;"></i>
                    <div class="stat-number" id="sharedCount">0</div>
                    <div class="stat-label">Ù…Ù„ÙØ§Øª Ù…Ø´Ø§Ø±ÙƒØ©</div>
                </div>
            </div>

            <!-- Upload Area -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <i class="bi bi-cloud-arrow-up"></i>
                </div>
                <div class="upload-text">Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>
                <div class="upload-subtext">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ ÙˆÙ‚Øª ÙˆØ§Ø­Ø¯</div>
                <input type="file" id="fileInput" style="display: none;" multiple>
            </div>

            <!-- File List -->
            <div class="file-list" id="fileListGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; background: transparent; box-shadow: none; padding: 0;">
                <!-- Grid view will be populated here -->
            </div>

            <div class="file-list" id="fileListTable" style="display: none;">
                <div class="file-list-header">
                    <div style="width: 30px;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                    </div>
                    <div>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</div>
                    <div>Ø§Ù„Ø­Ø¬Ù…</div>
                    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
                    <div>Ø§Ù„ÙØ¦Ø©</div>
                    <div>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                </div>
                <div id="fileListContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª</div>
                        <div class="empty-state-subtext">Ø§Ø¨Ø¯Ø£ Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø¢Ù†</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ø®ØªØ± Ù…Ù„ÙØ§Øª:</label>
                            <input type="file" class="form-control" id="modalFileInput" multiple required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙØ¦Ø©:</label>
                            <select class="form-control" id="categorySelect" required>
                                <option value="">-- Ø§Ø®ØªØ± ÙØ¦Ø© --</option>
                                <option value="Personal">Ø´Ø®ØµÙŠ</option>
                                <option value="Work">Ø§Ù„Ø¹Ù…Ù„</option>
                                <option value="Projects">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</option>
                                <option value="Reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</option>
                                <option value="Contracts">Ø§Ù„Ø¹Ù‚ÙˆØ¯</option>
                                <option value="Invoices">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</option>
                                <option value="Proposals">Ø§Ù„Ø¹Ø±ÙˆØ¶</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
                            <textarea class="form-control" id="descriptionInput" rows="3"></textarea>
                        </div>
                        <div id="uploadProgress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     id="progressBar" style="width: 0%"></div>
                            </div>
                            <p id="progressText" class="mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" onclick="uploadFiles()">ØªØ­Ù…ÙŠÙ„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="shareForm">
                        <div class="mb-3">
                            <label class="form-label"><strong>Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… <span style="color: #dc3545;">*</span></strong></label>
                            <select class="form-select" id="shareUserSelect" required>
                                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… --</option>
                                <?php
                                // Get all users except current user
                                $users_sql = "SELECT userid, username FROM user WHERE userid != '" . intval($_SESSION['useridv']) . "' ORDER BY username ASC";
                                $users_result = mysql_query($users_sql, $link);
                                while ($user_row = mysql_fetch_array($users_result)) {
                                    echo '<option value="' . intval($user_row['userid']) . '">' . htmlspecialchars($user_row['username']) . '</option>';
                                }
                                ?>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><strong>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</strong></label>
                            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="permissionSelect"
                                           id="permView" value="view" checked>
                                    <label class="form-check-label" for="permView">
                                        <strong>ğŸ‘ï¸ Ø¹Ø±Ø¶ ÙÙ‚Ø·</strong><br>
                                        <small style="color: #666;">ÙŠÙ…ÙƒÙ† Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙ‚Ø·</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="permissionSelect"
                                           id="permDownload" value="download">
                                    <label class="form-check-label" for="permDownload">
                                        <strong>ğŸ“¥ ØªØ­Ù…ÙŠÙ„</strong><br>
                                        <small style="color: #666;">ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</small>
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="permissionSelect"
                                           id="permEdit" value="edit">
                                    <label class="form-check-label" for="permEdit">
                                        <strong>âœï¸ ØªØ¹Ø¯ÙŠÙ„</strong><br>
                                        <small style="color: #666;">ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø® Ø¬Ø¯ÙŠØ¯Ø©</small>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="permissionSelect"
                                           id="permShare" value="share">
                                    <label class="form-check-label" for="permShare">
                                        <strong>ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</strong><br>
                                        <small style="color: #666;">ÙŠÙ…ÙƒÙ† Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                            <input type="date" class="form-control" id="expiryDate">
                            <small style="color: #666;">Ø§ØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¯Ø§Ø¦Ù…</small>
                        </div>

                        <div id="shareError" style="display: none;" class="alert alert-danger"></div>
                    </form>

                    <!-- Existing shares -->
                    <div class="mt-4">
                        <h6>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h6>
                        <div id="currentShares" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: #999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn btn-primary" onclick="submitShare()">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-trash" style="font-size: 48px; color: #dc3545;"></i>
                    <h5 class="mt-3">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ</h5>
                    <p class="text-muted">Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                    <div class="d-flex align-items-center w-100">
                        <i class="bi bi-eye-fill me-2" style="font-size: 1.5rem;"></i>
                        <div class="flex-grow-1">
                            <h5 class="modal-title mb-0" id="previewTitle">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</h5>
                            <small id="previewFileSize" style="opacity: 0.9;">-</small>
                        </div>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>

                <div class="modal-body p-0" style="background: #f8f9fa; min-height: 500px; max-height: 70vh; overflow: auto;">
                    <!-- Image Preview -->
                    <div id="imagePreview" class="p-4" style="display: none; text-align: center; background: white;">
                        <img id="previewImageTag" style="max-width: 100%; max-height: 600px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
                    </div>

                    <!-- PDF Preview -->
                    <div id="pdfPreview" class="p-3" style="display: none; background: white;">
                        <div class="text-center mb-3">
                            <canvas id="pdfCanvas" style="max-width: 100%; border: 1px solid #dee2e6; border-radius: 8px;"></canvas>
                        </div>
                        <div class="d-flex justify-content-center align-items-center gap-3 p-3 bg-light rounded">
                            <button id="pdfPrevBtn" class="btn btn-outline-primary btn-sm" onclick="previousPdfPage()">
                                <i class="bi bi-chevron-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚
                            </button>
                            <span id="pdfPageInfo" class="badge bg-primary">-</span>
                            <button id="pdfNextBtn" class="btn btn-outline-primary btn-sm" onclick="nextPdfPage()">
                                Ø§Ù„ØªØ§Ù„ÙŠ <i class="bi bi-chevron-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Text/Code Preview -->
                    <div id="textPreview" class="p-3" style="display: none; background: white;">
                        <pre id="previewTextContent" class="p-3 bg-light rounded" style="max-height: 500px; overflow: auto; font-family: 'Courier New', monospace; font-size: 14px;"></pre>
                    </div>

                    <!-- Video Preview -->
                    <div id="videoPreview" class="p-4" style="display: none; text-align: center; background: white;">
                        <video id="previewVideoTag" controls style="max-width: 100%; max-height: 500px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                        </video>
                    </div>

                    <!-- Audio Preview -->
                    <div id="audioPreview" class="p-5" style="display: none; text-align: center; background: white;">
                        <div class="mb-4">
                            <i class="bi bi-music-note-beamed" style="font-size: 80px; color: #667eea;"></i>
                        </div>
                        <audio id="previewAudioTag" controls class="w-100" style="max-width: 500px;">
                            Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª
                        </audio>
                    </div>

                    <!-- Office Documents Preview (Word, Excel, PowerPoint) -->
                    <div id="officePreview" class="p-4" style="display: none; background: white;">
                        <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2" style="font-size: 24px;"></i>
                            <div>
                                <strong>Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ø­Ø¯ÙˆØ¯Ø© Ù„Ù…Ù„ÙØ§Øª Office</strong><br>
                                <small>Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙˆÙØªØ­Ù‡ ÙÙŠ Microsoft Office</small>
                            </div>
                        </div>

                        <div id="officeContent" class="p-4 bg-light rounded" style="max-height: 500px; overflow: auto; min-height: 300px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                                </div>
                                <p class="text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©...</p>
                            </div>
                        </div>

                        <div class="mt-3 text-center">
                            <button class="btn btn-primary" onclick="downloadFile(window.currentPreviewFileId)">
                                <i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ÙƒØ§Ù…Ù„
                            </button>
                        </div>
                    </div>

                    <!-- Unsupported Preview -->
                    <div id="unsupportedPreview" class="p-5" style="display: none; text-align: center; background: white;">
                        <div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 400px;">
                            <i class="bi bi-file-earmark-x" style="font-size: 80px; color: #999; margin-bottom: 20px;"></i>
                            <h5 class="text-secondary mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h5>
                            <p class="text-muted mb-4">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„Ø¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
                            <button class="btn btn-primary btn-lg" onclick="downloadFile(window.currentPreviewFileId)">
                                <i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
                            </button>
                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="border-top: 1px solid #dee2e6;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Ø¥ØºÙ„Ø§Ù‚
                    </button>
                    <button type="button" class="btn btn-primary" onclick="downloadFile(window.currentPreviewFileId)">
                        <i class="bi bi-download"></i> ØªØ­Ù…ÙŠÙ„
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <script>
        let currentFilter = 'all';
        let uploadModal, shareModal;

        // Initialize modals
        document.addEventListener('DOMContentLoaded', function() {
            uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
            shareModal = new bootstrap.Modal(document.getElementById('shareModal'));

            // Load files on page load
            loadFiles();

            // Setup drag and drop
            setupDragAndDrop();

            // Setup file input
            document.getElementById('fileInput').addEventListener('change', function(e) {
                handleFileSelect(e);
            });
        });

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                document.getElementById('fileInput').files = files;
                handleFileSelect({ target: { files: files } });
            });
        }

        function handleFileSelect(e) {
            // Handle file selection
            showUploadModal();
            const files = e.target.files;
            document.getElementById('modalFileInput').files = files;
        }

        function showUploadModal() {
            uploadModal.show();
        }

        function uploadFiles() {
            const fileInput = document.getElementById('modalFileInput');
            const category = document.getElementById('categorySelect').value;
            const description = document.getElementById('descriptionInput').value;
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            if (!category) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø©');
                return;
            }

            // Show progress
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';

            // Upload files one by one
            const files = Array.from(fileInput.files);
            let uploadedCount = 0;
            let failedCount = 0;

            function uploadNextFile(index) {
                if (index >= files.length) {
                    // All files processed
                    progressText.textContent = `Ø§ÙƒØªÙ…Ù„! ØªÙ… ØªØ­Ù…ÙŠÙ„ ${uploadedCount} Ù…Ù„Ù${failedCount > 0 ? `, ÙØ´Ù„ ${failedCount}` : ''}`;
                    setTimeout(() => {
                        uploadModal.hide();
                        progressDiv.style.display = 'none';
                        loadFiles(); // Reload file list
                        // Reset form
                        document.getElementById('uploadForm').reset();
                    }, 1500);
                    return;
                }

                const file = files[index];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);
                formData.append('description', description);

                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        const overallPercent = Math.round(((index + (percentComplete / 100)) / files.length) * 100);
                        progressBar.style.width = overallPercent + '%';
                        progressText.textContent = `Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ${file.name} (${percentComplete}%)...`;
                    }
                });

                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                uploadedCount++;
                            } else {
                                failedCount++;
                                console.error('Upload failed:', response.message);
                            }
                        } catch (e) {
                            failedCount++;
                            console.error('Parse error:', e);
                        }
                    } else {
                        failedCount++;
                        console.error('Upload failed with status:', xhr.status);
                    }
                    // Upload next file
                    uploadNextFile(index + 1);
                });

                xhr.addEventListener('error', function() {
                    failedCount++;
                    console.error('Upload error for file:', file.name);
                    uploadNextFile(index + 1);
                });

                xhr.open('POST', 'api/upload.hnt', true);
                xhr.send(formData);
            }

            // Start uploading
            uploadNextFile(0);
        }

        function filterByCategory(category) {
            currentFilter = category;
            // Update active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-item').classList.add('active');

            // Update title
            const titles = {
                'all': 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª',
                'Personal': 'Ù…Ù„ÙØ§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©',
                'Work': 'Ù…Ù„ÙØ§Øª Ø§Ù„Ø¹Ù…Ù„',
                'Projects': 'Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
                'Reports': 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
                'Contracts': 'Ø§Ù„Ø¹Ù‚ÙˆØ¯',
                'Invoices': 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
                'Proposals': 'Ø§Ù„Ø¹Ø±ÙˆØ¶'
            };
            document.getElementById('pageTitle').textContent = titles[category] || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª';

            loadFiles();
        }

        function showSharedWithMe() {
            document.getElementById('pageTitle').textContent = 'Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ÙŠ';
            const gridContainer = document.getElementById('fileListGrid');

            gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="bi bi-hourglass-split" style="font-size: 48px; color: #999;"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            fetch('api/shared-files.hnt?view=with_me&page=1&limit=100')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files && data.files.length > 0) {
                        displaySharedFiles(data.files);
                    } else {
                        gridContainer.innerHTML = `
                            <div style="grid-column: 1/-1;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="bi bi-share"></i>
                                    </div>
                                    <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø´Ø§Ø±ÙƒØ©</div>
                                    <div class="empty-state-subtext">Ù„Ù… ÙŠØ´Ø§Ø±Ùƒ Ø£Ø­Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø¹Ùƒ Ø¨Ø¹Ø¯</div>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p></div>';
                });
        }

        function displaySharedFiles(files) {
            const gridContainer = document.getElementById('fileListGrid');
            let html = '';

            files.forEach(file => {
                const icon = getFileIcon(file.file_type);
                const truncatedName = truncateFilename(file.filename, 30);
                const sharedBy = file.shared_by_username || 'Ù…Ø³ØªØ®Ø¯Ù…';
                const permission = file.permission_type || 'view';

                html += `
                    <div class="file-card">
                        <div class="file-icon">
                            ${icon}
                            <span class="badge bg-info" style="position: absolute; top: 5px; right: 5px; font-size: 10px;">
                                <i class="bi bi-share"></i>
                            </span>
                        </div>
                        <div class="file-info">
                            <div class="file-name" title="${file.filename}">${truncatedName}</div>
                            <div class="file-meta">
                                <span><i class="bi bi-person"></i> ${sharedBy}</span>
                                <span><i class="bi bi-hdd"></i> ${file.file_size_formatted}</span>
                            </div>
                            <div class="file-category">
                                <i class="bi bi-shield-check"></i> ${getPermissionLabel(permission)}
                            </div>
                            ${file.description ? `<div class="file-category" style="color: #666; font-size: 12px;"><i class="bi bi-info-circle"></i> ${file.description}</div>` : ''}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewFile(${file.file_id})" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${permission === 'download' || permission === 'edit' ? `
                            <button class="btn btn-sm btn-outline-success" onclick="downloadFile(${file.file_id})" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="bi bi-download"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            gridContainer.innerHTML = html;
        }

        function getPermissionLabel(permission) {
            const labels = {
                'view': 'Ø¹Ø±Ø¶ ÙÙ‚Ø·',
                'download': 'ØªØ­Ù…ÙŠÙ„',
                'edit': 'ØªØ¹Ø¯ÙŠÙ„',
                'share': 'Ù…Ø´Ø§Ø±ÙƒØ©'
            };
            return labels[permission] || permission;
        }

        function showRecycleBin() {
            document.getElementById('pageTitle').textContent = 'Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª';
            const gridContainer = document.getElementById('fileListGrid');

            gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="bi bi-hourglass-split" style="font-size: 48px; color: #999;"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            fetch('api/deleted-files.hnt?page=1&limit=100')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files && data.files.length > 0) {
                        displayDeletedFiles(data.files);
                    } else {
                        gridContainer.innerHTML = `
                            <div style="grid-column: 1/-1;">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="bi bi-trash"></i>
                                    </div>
                                    <div class="empty-state-text">Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙØ§Ø±ØºØ©</div>
                                    <div class="empty-state-subtext">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù…Ø­Ø°ÙˆÙØ©</div>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ù„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª</p></div>';
                });
        }

        function displayDeletedFiles(files) {
            const gridContainer = document.getElementById('fileListGrid');
            let html = '';

            files.forEach(file => {
                const icon = getFileIcon(file.file_type);
                const truncatedName = truncateFilename(file.filename, 30);

                html += `
                    <div class="file-card" style="opacity: 0.7;">
                        <div class="file-icon">
                            ${icon}
                            <span class="badge bg-danger" style="position: absolute; top: 5px; right: 5px; font-size: 10px;">
                                <i class="bi bi-trash"></i>
                            </span>
                        </div>
                        <div class="file-info">
                            <div class="file-name" title="${file.filename}">${truncatedName}</div>
                            <div class="file-meta">
                                <span><i class="bi bi-hdd"></i> ${file.file_size_formatted}</span>
                                <span><i class="bi bi-clock"></i> ${file.deleted_date_formatted}</span>
                            </div>
                            ${file.category ? `<div class="file-category"><i class="bi bi-tag"></i> ${file.category}</div>` : ''}
                            ${file.description ? `<div class="file-category" style="color: #666; font-size: 12px;"><i class="bi bi-info-circle"></i> ${file.description}</div>` : ''}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-success" onclick="restoreFile(${file.file_id})" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©">
                                <i class="bi bi-arrow-counterclockwise"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="permanentDelete(${file.file_id})" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                                <i class="bi bi-x-circle"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                            </button>
                        </div>
                    </div>
                `;
            });

            gridContainer.innerHTML = html;
        }

        function restoreFile(fileId) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ')) return;

            const formData = new FormData();
            formData.append('file_id', fileId);

            fetch('api/restore.hnt', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                    showRecycleBin(); // Reload recycle bin
                } else {
                    alert('ÙØ´Ù„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù');
            });
        }

        function permanentDelete(fileId) {
            if (!confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            // TODO: Implement permanent delete API
            alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        function toggleListView() {
            // Placeholder for list/grid view toggle
        }

        function loadFiles() {
            // Show loading state
            const gridContainer = document.getElementById('fileListGrid');
            const tableContainer = document.getElementById('fileListContainer');

            gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="bi bi-hourglass-split" style="font-size: 48px; color: #999;"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';

            // Fetch files from API
            fetch(`api/list.hnt?category=${currentFilter}&page=1&limit=100`)
                .then(response => response.json())
                .then(data => {
                    console.log('API Response:', data);
                    if (data.success && data.files) {
                        try {
                            displayFiles(data.files);
                            updateStats(data.statistics || {});
                        } catch (e) {
                            console.error('Error in displayFiles or updateStats:', e);
                            gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i><p>Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + e.message + '</p></div>';
                        }
                    } else {
                        showEmptyState();
                    }
                })
                .catch(error => {
                    console.error('Error loading files:', error);
                    gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª: ' + error.message + '</p></div>';
                });
        }

        function showEmptyState() {
            const gridContainer = document.getElementById('fileListGrid');
            gridContainer.innerHTML = `
                <div style="grid-column: 1/-1;">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="bi bi-inbox"></i>
                        </div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª</div>
                        <div class="empty-state-subtext">Ø§Ø¨Ø¯Ø£ Ø¨Ø±ÙØ¹ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø¢Ù†</div>
                    </div>
                </div>
            `;
        }

        function displayFiles(files) {
            const gridContainer = document.getElementById('fileListGrid');

            if (!files || files.length === 0) {
                showEmptyState();
                return;
            }

            let html = '';
            files.forEach(file => {
                const icon = getFileIcon(file.file_type);
                const truncatedName = truncateFilename(file.filename, 30);

                html += `
                    <div class="file-card">
                        <div class="file-icon">
                            ${icon}
                        </div>
                        <div class="file-info">
                            <div class="file-name" title="${file.filename}">${truncatedName}</div>
                            <div class="file-meta">
                                <span><i class="bi bi-hdd"></i> ${file.file_size_formatted}</span>
                                <span><i class="bi bi-calendar"></i> ${file.created_date_formatted}</span>
                            </div>
                            ${file.category ? `<div class="file-category"><i class="bi bi-tag"></i> ${file.category}</div>` : ''}
                            ${file.description ? `<div class="file-category" style="color: #666; font-size: 12px;"><i class="bi bi-info-circle"></i> ${file.description}</div>` : ''}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewFile(${file.file_id})" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="downloadFile(${file.file_id})" title="ØªØ­Ù…ÙŠÙ„">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="shareFileModal(${file.file_id})" title="Ù…Ø´Ø§Ø±ÙƒØ©">
                                <i class="bi bi-share"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.preventDefault(); event.stopPropagation(); deleteFile(${file.file_id}); return false;" title="Ø­Ø°Ù">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            gridContainer.innerHTML = html;
        }

        function updateStats(stats) {
            // API returns 'statistics' object, not 'stats'
            document.getElementById('totalFiles').textContent = stats.total_files || 0;
            document.getElementById('totalSize').textContent = stats.total_size_formatted || formatFileSize(stats.total_size || 0);
            document.getElementById('sharedCount').textContent = stats.shared_files || 0;
        }

        function getFileIcon(fileType) {
            const icons = {
                'pdf': '<i class="bi bi-file-pdf-fill" style="color: #dc3545;"></i>',
                'doc': '<i class="bi bi-file-word-fill" style="color: #0d6efd;"></i>',
                'docx': '<i class="bi bi-file-word-fill" style="color: #0d6efd;"></i>',
                'xls': '<i class="bi bi-file-excel-fill" style="color: #198754;"></i>',
                'xlsx': '<i class="bi bi-file-excel-fill" style="color: #198754;"></i>',
                'jpg': '<i class="bi bi-file-image-fill" style="color: #fd7e14;"></i>',
                'jpeg': '<i class="bi bi-file-image-fill" style="color: #fd7e14;"></i>',
                'png': '<i class="bi bi-file-image-fill" style="color: #fd7e14;"></i>',
                'gif': '<i class="bi bi-file-image-fill" style="color: #fd7e14;"></i>',
                'zip': '<i class="bi bi-file-zip-fill" style="color: #6c757d;"></i>',
                'rar': '<i class="bi bi-file-zip-fill" style="color: #6c757d;"></i>',
                'mp4': '<i class="bi bi-file-play-fill" style="color: #6f42c1;"></i>',
                'mp3': '<i class="bi bi-file-music-fill" style="color: #d63384;"></i>',
                'txt': '<i class="bi bi-file-text-fill" style="color: #0dcaf0;"></i>'
            };
            return icons[fileType.toLowerCase()] || '<i class="bi bi-file-earmark" style="color: #6c757d;"></i>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function truncateFilename(filename, maxLength) {
            if (filename.length <= maxLength) return filename;
            const ext = filename.split('.').pop();
            const nameWithoutExt = filename.substring(0, filename.lastIndexOf('.'));
            const truncated = nameWithoutExt.substring(0, maxLength - ext.length - 4) + '...';
            return truncated + '.' + ext;
        }

        function downloadFile(fileId) {
            window.location.href = `api/download.hnt?file_id=${fileId}`;
        }

        function deleteFile(fileId) {
            // Store file ID for confirmation
            window.pendingDeleteFileId = fileId;

            // Show Bootstrap confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        }

        // Handle delete confirmation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const fileId = window.pendingDeleteFileId;

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                modal.hide();

                // Perform delete
                fetch('api/delete.hnt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: fileId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                        loadFiles();
                    } else {
                        alert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù: ' + error.message);
                });
            });
        });

        function previewFile(fileId) {
            // Store file ID for download button
            window.currentPreviewFileId = fileId;

            // Fetch file info from API
            fetch(`api/preview.hnt?file_id=${fileId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const modal = new bootstrap.Modal(document.getElementById('previewModal'));
                        document.getElementById('previewTitle').textContent = data.filename;
                        document.getElementById('previewFileSize').textContent = formatFileSize(data.file_size);

                        // Hide all preview containers
                        document.getElementById('imagePreview').style.display = 'none';
                        document.getElementById('pdfPreview').style.display = 'none';
                        document.getElementById('textPreview').style.display = 'none';
                        document.getElementById('videoPreview').style.display = 'none';
                        document.getElementById('audioPreview').style.display = 'none';
                        document.getElementById('officePreview').style.display = 'none';
                        document.getElementById('unsupportedPreview').style.display = 'none';

                        const mimeType = (data.mime_type || '').toLowerCase();
                        const fileName = (data.filename || '').toLowerCase();
                        const fileExt = fileName.split('.').pop();
                        const fileUrl = data.url;

                        console.log('Preview data:', {mimeType, fileName, fileExt, fileUrl});

                        // Handle different file types - check both mime type and extension
                        if (mimeType.includes('image') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(fileExt)) {
                            // Image preview
                            document.getElementById('imagePreview').style.display = 'block';
                            document.getElementById('previewImageTag').src = fileUrl;
                        } else if (mimeType.includes('pdf') || fileExt === 'pdf') {
                            // PDF preview
                            document.getElementById('pdfPreview').style.display = 'block';
                            loadPDF(fileUrl);
                        } else if (mimeType.includes('text') || ['txt', 'log', 'md', 'json', 'xml', 'csv'].includes(fileExt)) {
                            // Text file preview
                            document.getElementById('textPreview').style.display = 'block';
                            fetch(fileUrl)
                                .then(r => r.text())
                                .then(text => {
                                    document.getElementById('previewTextContent').textContent = text;
                                });
                        } else if (mimeType.includes('video') || ['mp4', 'webm', 'ogg', 'mov', 'avi'].includes(fileExt)) {
                            // Video preview
                            document.getElementById('videoPreview').style.display = 'block';
                            document.getElementById('previewVideoTag').src = fileUrl;
                        } else if (mimeType.includes('audio') || ['mp3', 'wav', 'ogg', 'm4a'].includes(fileExt)) {
                            // Audio preview
                            document.getElementById('audioPreview').style.display = 'block';
                            document.getElementById('previewAudioTag').src = fileUrl;
                        } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExt) ||
                                   mimeType.includes('word') || mimeType.includes('excel') || mimeType.includes('powerpoint') ||
                                   mimeType.includes('officedocument')) {
                            // Office documents - show file info and download option
                            document.getElementById('officePreview').style.display = 'block';

                            // Determine file type icon and name
                            let fileTypeInfo = {
                                icon: 'bi-file-earmark-word',
                                color: '#2b579a',
                                typeName: 'Ù…Ø³ØªÙ†Ø¯ Word'
                            };

                            if (['xls', 'xlsx'].includes(fileExt)) {
                                fileTypeInfo = {
                                    icon: 'bi-file-earmark-excel',
                                    color: '#217346',
                                    typeName: 'Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Excel'
                                };
                            } else if (['ppt', 'pptx'].includes(fileExt)) {
                                fileTypeInfo = {
                                    icon: 'bi-file-earmark-ppt',
                                    color: '#d24726',
                                    typeName: 'Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠ PowerPoint'
                                };
                            }

                            // Display file information as simple HTML table
                            document.getElementById('officeContent').innerHTML = `
                                <div class="text-center py-4">
                                    <h5 class="mb-4">${data.filename}</h5>
                                    <div class="row justify-content-center">
                                        <div class="col-md-8">
                                            <table class="table table-bordered">
                                                <tbody>
                                                    <tr>
                                                        <td><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù</strong></td>
                                                        <td>${fileTypeInfo.typeName}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Ø§Ù„Ø­Ø¬Ù…</strong></td>
                                                        <td>${formatFileSize(data.file_size)}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯</strong></td>
                                                        <td>.${fileExt.toUpperCase()}</td>
                                                    </tr>
                                                    <tr>
                                                        <td><strong>Ù†ÙˆØ¹ MIME</strong></td>
                                                        <td>${mimeType || 'application/octet-stream'}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <p class="text-muted mt-3">
                                                <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù„ÙØ§Øª Office Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.
                                                ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ù„ÙØªØ­Ù‡ ÙÙŠ Microsoft Office Ø£Ùˆ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªÙˆØ§ÙÙ‚.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Unsupported - show download option
                            document.getElementById('unsupportedPreview').style.display = 'block';
                            window.currentPreviewFileId = fileId;
                        }

                        modal.show();
                    } else {
                        alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
                });
        }

        function loadPDF(url) {
            const pdfjsLib = window['pdfjs-dist/build/pdf'];
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

            pdfjsLib.getDocument(url).promise.then(pdf => {
                window.currentPDF = pdf;
                window.currentPDFPage = 1;
                renderPDFPage(1);
            });
        }

        function renderPDFPage(pageNum) {
            const pdf = window.currentPDF;
            pdf.getPage(pageNum).then(page => {
                const canvas = document.getElementById('pdfCanvas');
                const context = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 1.5 });

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                page.render({
                    canvasContext: context,
                    viewport: viewport
                });

                document.getElementById('pdfPageInfo').textContent = `ØµÙØ­Ø© ${pageNum} Ù…Ù† ${pdf.numPages}`;
                document.getElementById('pdfPrevBtn').disabled = pageNum <= 1;
                document.getElementById('pdfNextBtn').disabled = pageNum >= pdf.numPages;
            });
        }

        function previousPdfPage() {
            if (window.currentPDFPage > 1) {
                window.currentPDFPage--;
                renderPDFPage(window.currentPDFPage);
            }
        }

        function nextPdfPage() {
            if (window.currentPDFPage < window.currentPDF.numPages) {
                window.currentPDFPage++;
                renderPDFPage(window.currentPDFPage);
            }
        }

        function shareFileModal(fileId) {
            window.currentShareFileId = fileId;
            const modal = new bootstrap.Modal(document.getElementById('shareModal'));

            // Reset form
            document.getElementById('shareUserSelect').value = '';
            document.getElementById('permView').checked = true;
            document.getElementById('expiryDate').value = '';

            modal.show();
        }

        function submitShare() {
            const fileId = window.currentShareFileId;
            const sharedWithUserid = document.getElementById('shareUserSelect').value;
            const permissionType = document.querySelector('input[name="permissionSelect"]:checked').value;
            const expiryDate = document.getElementById('expiryDate').value;

            if (!sharedWithUserid) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªØ®Ø¯Ù…');
                return;
            }

            const formData = new FormData();
            formData.append('action', 'share');
            formData.append('file_id', fileId);
            formData.append('shared_with_userid', sharedWithUserid);
            formData.append('permission_type', permissionType);
            if (expiryDate) {
                formData.append('expiry_date', expiryDate);
            }

            fetch('api/manage-sharing.hnt', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­');
                    bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
                } else {
                    alert('ÙØ´Ù„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù');
            });
        }

        function toggleSearchFilters() {
            const section = document.getElementById('searchFilterSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('fileTypeFilter').value = '';
            document.getElementById('sortByFilter').value = 'created_date';
            document.getElementById('dateFromFilter').value = '';
            document.getElementById('dateToFilter').value = '';
            applyFilters();
        }

        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value.trim();
            const fileType = document.getElementById('fileTypeFilter').value;
            const sortBy = document.getElementById('sortByFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            // Build query parameters
            let params = new URLSearchParams();

            if (searchQuery) params.append('q', searchQuery);
            if (currentFilter && currentFilter !== 'all') params.append('category', currentFilter);
            if (fileType) params.append('file_type', fileType);
            if (sortBy) params.append('sort_by', sortBy);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            params.append('page', '1');
            params.append('limit', '100');

            // Show loading state
            const gridContainer = document.getElementById('fileListGrid');
            gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="bi bi-hourglass-split" style="font-size: 48px; color: #999;"></i><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p></div>';

            // Fetch from search API
            fetch(`api/search.hnt?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.files) {
                        displayFiles(data.files);
                        if (data.pagination) {
                            console.log(`Found ${data.pagination.total} files`);
                        }
                    } else {
                        showEmptyState();
                    }
                })
                .catch(error => {
                    console.error('Error searching files:', error);
                    gridContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc3545;"><i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i><p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</p></div>';
                });
        }

        function debounceSearch() {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        }
    </script>
</div>
<!-- End File Management Container -->

<?php require("../../foter.hnt"); ?>
